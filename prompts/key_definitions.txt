# Key Definitions Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate ONLY the Key Definitions content in the Generated SAP. This includes variable definitions, calculation formulas, study period definitions, and operational definitions.

Do NOT evaluate analysis population definitions, study objectives, endpoint definitions, efficacy analysis methods, or general statistical methodology — those are evaluated in separate prompts.

**CRITICAL**: Read the Original SAP sentence by sentence. Every sentence that contains a specification is a component to evaluate. Do not skip any sentence. Do not filter by category.

---

## EVALUATION HIERARCHY

There are TWO separate checks. Do not conflate them.

### CHECK 1: EXISTENCE (Does the element exist?)

Use this hierarchy only when an entire component is absent from Generated SAP:
1. Check if element exists in Original SAP
2. If entirely absent from Generated SAP → Check Protocol
3. If element exists in Protocol → **PROBLEM** (missing required element) → classification = `missing_required`
4. If element only exists in Original SAP (not in Protocol) → **ACCEPTABLE** (not required) → classification = `acceptable_difference`

**CLASSIFICATION RULE**: The `classification` field in `missing_from_generated_sap` MUST be:
- `missing_required` → ONLY when `in_protocol` = "yes"
- `acceptable_difference` → ONLY when `in_protocol` = "no"

**When NOT to use Protocol:**
- Component exists in Generated SAP but is shorter/abbreviated → Do NOT check Protocol
- Component exists but omits qualifiers/details → Do NOT check Protocol
- These are CONTENT differences, not EXISTENCE differences

### CHECK 2: CONTENT (What does it say?)

Compare to Original SAP ONLY.

**DO NOT use Protocol to evaluate content differences. Protocol is ONLY for EXISTENCE checks.**

For CONTENT, ask these questions:
1. Does Generated SAP match Original SAP? → **CORRECT**
2. Does Generated SAP omit only minor wording but preserve ALL specifics? → **ACCEPTABLE**
3. Does Generated SAP omit methodological steps, formulas, specific values, or procedural details? → **PROBLEM** (missing_specification)
4. Does Generated SAP contradict Original SAP? → **PROBLEM** (contradiction)

| Scenario | Result |
|----------|--------|
| Generated SAP content matches Original SAP | **CORRECT** |
| Generated SAP has minor wording differences but includes all specifics | **ACCEPTABLE** |
| Original SAP has steps/formulas/values, Generated SAP mentions concept but lacks specifics | **PROBLEM** (missing_specification) |
| Generated SAP says something DIFFERENT that contradicts Original SAP | **PROBLEM** (contradiction) |

**How to distinguish these categories:**
- ACCEPTABLE: Only minor wording omitted (adjectives, qualifiers, clarifying phrases). ALL methodology steps, formulas, and specific values are still present.
- MISSING SPECIFICATION: Original SAP provides HOW (steps, formulas, specific values). Generated SAP only says WHAT (mentions the method/concept but omits the specifics). This is a PROBLEM.
- CONTRADICTION: Generated SAP states something incompatible with Original SAP (cannot both be true)

**For EVERY contradiction, you MUST provide:**
1. FULL VERBATIM quote from Original SAP - do NOT truncate with "..." - include the complete sentence or paragraph
2. FULL VERBATIM quote from Generated SAP - do NOT truncate with "..." - include the complete sentence or paragraph
3. Chain-of-thought reasoning explaining:
   - What Original SAP says (with specific section reference)
   - What Generated SAP says (with specific section reference)
   - Why both statements cannot be true at the same time
   - The specific conflict between them

**QUOTE REQUIREMENT**: All quotes in issues, evaluation_table, and missing_from_generated_sap MUST be COMPLETE. Never use "..." to abbreviate. If a definition spans multiple sentences, include all of them.

---

## EVALUATION RULES

**CRITICAL**: Do not copy text between fields. The original_sap_text must come from the Original SAP document, not from Generated SAP. Quote VERBATIM text from each document first, then compare semantically. Do not paraphrase or summarize. **NEVER truncate quotes with "..." - always provide the COMPLETE text.**

**For ALL content types:**
- Compare to Original SAP first
- If Generated SAP matches Original SAP → CORRECT
- If Generated SAP contradicts Original SAP → PROBLEM
- Check if Original SAP contains any updates or amendments. If Generated SAP uses an old definition instead of the updated one, this is a contradiction

---

## EXTRA INFORMATION HANDLING

Generated SAP may contain definitions not present in Original SAP.

- Extra definitions that do NOT contradict → FLAG as extra, but NEUTRAL (do not penalize)
- Extra definitions that CONTRADICT Original SAP → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: EXHAUSTIVE EXTRACTION

**EXTRACTION GRANULARITY:**
Each sentence is a separate entry. If a paragraph contains multiple sentences, extract each sentence as its own entry. Do NOT group multiple sentences into one entry.

Read ONLY the sections of the Original SAP that cover key definitions, variable definitions, calculation formulas, study period definitions, and operational definitions. Read section by section, then sentence by sentence within each section. For each statement, rule, or definition:
1. Note which section/subsection it comes from
2. Extract the EXACT TEXT (word-for-word quote)
3. Do not paraphrase or summarize
4. Do not fit into predefined categories
5. Create one entry per statement
6. Count elements per section separately — record in `elements_per_section`

**CONJUNCTION RULE (CRITICAL):**
When a sentence contains "X and Y" or "X, Y, and Z", split into SEPARATE elements.

**CONJUNCTION VERIFICATION:**
Before moving to Phase 2, review every extracted element. If any element contains "and" or "or" joining two different items, STOP and split it into separate entries.

**NO DEDUPLICATION:**
Do not deduplicate. If the same or similar specification appears multiple times in the document, each occurrence is a separate entry. Different locations in the document mean different entries. Specifications that look similar but apply to different items are NOT duplicates.

**SIBLING SUBSECTION CHECK:**
After extracting from all subsections, compare element counts across subsections at the same level. If sibling subsections cover parallel content but have different element counts, re-read the subsection with fewer elements to check if you missed anything.

**COUNT YOUR ELEMENTS:**
After extraction, count the total number of elements you extracted. Record this number - it will be verified later.

### PHASE 2: COMPARISON AND CLASSIFICATION

**TRACKING RULE:**
Every element extracted in Phase 1 MUST appear in either evaluation_table OR missing_from_generated_sap. No element can be skipped or lost.

**Step A**: For each extracted element, search Generated SAP
- Identify the key terms from the Original SAP element
- Search the ENTIRE Generated SAP for those key terms
- When found, copy the EXACT sentence word-for-word as generated_sap_text
- Do NOT paraphrase, summarize, or reword what you find
- Only record null if no content with those key terms exists in the entire document

**Step B**: Compare statements directly
- Ask: "Can both statements be true at the same time?"
- If YES → matches_original_sap: "yes" (no conflict, statements are compatible)
- If NO → matches_original_sap: "no" (contradiction, statements conflict)

**Step C**: Determine detail_level
- match: Generated SAP text is equivalent to Original SAP text
- less_detailed: Generated SAP omits words/clauses but core meaning preserved
- contradiction: Generated SAP states something incompatible with Original SAP

**Step D**: For less_detailed items, document omissions
- Record exactly what words, clauses, steps, formulas, or values were omitted in `omitted_content`
- Assess `omission_impact`: none | low | potential (could this omission change meaning?)

**Step E**: For missing items, check Protocol
- Search the ENTIRE Protocol document for the same element
- Content may be worded differently - look for semantic match
- Record in_protocol: "yes" if concept exists (even if worded differently)
- Record in_protocol: "no" ONLY if concept is truly absent after thorough search

### PHASE 3: OUTPUT COMPLETENESS VERIFICATION

**OUTPUT COMPLETENESS RULE:**
Your output arrays (evaluation_table + missing_from_generated_sap) must contain exactly the same number of entries as elements_extracted.

Before generating output:
1. Count your extracted elements from Phase 1
2. Ensure every single one has a corresponding entry in either evaluation_table OR missing_from_generated_sap
3. Do NOT consolidate, summarize, or merge entries in the output
4. One extracted sentence = one output entry

If counts do not match, add the missing entries before proceeding.

---

## RATING CRITERIA

### GREAT
- All specifications from Original SAP are present in Generated SAP
- Content matches Original SAP
- No contradictions

### DECENT
- All required content present
- Minor wording differences that do not change meaning
- Small issues easily correctable

### POOR
- Required specifications missing
- Content contradicts Original SAP
- Significant gaps in coverage

**RATING RULE**: If ANY item has `classification: "missing_required"`, the rating MUST be POOR. If ANY item has a contradiction, the rating MUST be POOR.

---

## OUTPUT FORMAT

Provide BOTH markdown (for human review) AND JSON (for programmatic use).

---

## MARKDOWN OUTPUT

```markdown
## Key Definitions Evaluation

**Section:** key_definitions
**Rating:** [GREAT | DECENT | POOR]
**Status:** [pass | pass_with_notes | fail]

---

### Evaluation Summary Table

| Component | Evaluation Type | Matches Original SAP | Protocol Consulted | Result | Issue Type | Severity |
|-----------|-----------------|---------------------|-------------------|--------|------------|----------|
| [name] | exact_match / semantic | yes/no | yes/no/n/a | correct/acceptable/problem | none/contradiction | none/minor/critical |

---

### Issues Found

| Issue Type | Severity | Component | Original SAP Text | Generated SAP Text | Why They Conflict | Reasoning |
|------------|----------|-----------|-------------------|--------------------|--------------------|-----------|
| [type] | [severity] | [name] | "[exact quote]" | "[exact quote]" | [why both cannot be true] | [chain-of-thought] |

(If no issues: "*No issues found.*")

---

### Extra Information Flagged

| Content | Generated SAP Text | Contradicts | Detail |
|---------|-------------------|-------------|--------|
| [description] | "[quote]" | yes/no | [explanation] |

(If none: "*No extra information flagged.*")

---

### Missing from Generated SAP (X items)

| Component | Classification | In Protocol | Original SAP Text | Protocol Text | Reasoning |
|-----------|----------------|-------------|-------------------|---------------|-----------|
| [name] | missing_required/acceptable_difference | yes/no | "[quote]" | "[quote]" | [chain-of-thought] |

(If none: "*None - all required content is present.*")

---

### Reasoning

[Step-by-step chain-of-thought reasoning trace]

---

### Summary

[2-3 sentence overall assessment]
```

---

## JSON OUTPUT

```json
{
  "section": "key_definitions",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "extraction_validation": {
    "sections_read": ["list every section/subsection number read from Original SAP"],
    "elements_per_section": {"section_number": "count of elements extracted from that section"},
    "elements_extracted": 0,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "short description",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null",
      "protocol_text": "exact quote, or null if not consulted",
      "protocol_consulted": "yes | no | n/a",
      "matches_original_sap": "yes | no",
      "detail_level": "match | less_detailed | contradiction",
      "omitted_content": "REQUIRED: list specific words, clauses, steps, formulas, or values from Original SAP that are not in Generated SAP. Write 'none' only if exact match.",
      "omission_impact": "none | low | potential (could this omission change meaning?)",
      "result": "correct | acceptable | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "short description",
      "original_sap_text": "exact quote",
      "protocol_text": "exact quote if found, null if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "FULL VERBATIM QUOTE from Original SAP - NO truncation with ... (required)",
      "generated_sap_text": "FULL VERBATIM QUOTE from Generated SAP - NO truncation with ... (required)",
      "protocol_text": "exact quote if relevant",
      "why_they_conflict": "explanation of why both cannot be true at the same time",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought: 1) What Original SAP says, 2) What Generated SAP says, 3) Why these conflict, 4) Why both cannot be true"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

**counts_match MUST be true for valid output.**

Before finalizing your output, verify:
- `elements_extracted` = `elements_in_evaluation_table` + `elements_in_missing_from_generated_sap`
- `elements_extracted` = sum of all values in `elements_per_section`
- If the counts do not match, your output is INVALID - go back and find the missing elements
- If evaluation_table.length + missing_from_generated_sap.length ≠ elements_extracted, your output is INVALID

---

## CRITICAL REMINDERS

1. **Sentence by sentence**: Read every sentence in Original SAP. Each specification sentence is a component.
2. **No filtering**: Do not skip sentences. Do not filter by category. Extract everything.
3. **EXISTENCE vs CONTENT**: Protocol is ONLY for checking if missing elements are required, NOT for evaluating content differences.
5. **Compare to Original SAP first**: For content, always compare Generated SAP to Original SAP.
6. **Contradiction is a problem**: Generated SAP saying something incompatible with Original SAP is a problem.
7. **Extra info is neutral**: Flag but do not penalize extra information unless it contradicts.
8. **Blocking validation**: Ensure counts_match is true before outputting.
9. **Full quotes required**: NEVER use "..." to truncate quotes - always include complete text.
10. **Scope**: ONLY evaluate key definitions, variable definitions, calculation formulas, study period definitions, and operational definitions. Do NOT evaluate analysis populations, study objectives, endpoint definitions, efficacy analysis methods, or general statistical methodology.
