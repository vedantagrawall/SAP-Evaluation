# Key Definitions Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate ONLY the Key Definitions content in the Generated SAP. This includes variable definitions, calculation formulas, study period definitions, and operational definitions.

Do NOT evaluate analysis population definitions, study objectives, endpoint definitions, efficacy analysis methods, or general statistical methodology — those are evaluated in separate prompts.

**Start from the Generated SAP.** Find its Key Definitions section. Then find the corresponding content in the Original SAP for comparison. The Original SAP may have key definitions scattered across multiple sections rather than in a single dedicated section — search the entire Original SAP for corresponding content.

---

## EVALUATION HIERARCHY

There are TWO separate checks. Do not conflate them.

### CHECK 1: EXISTENCE (Does the element exist?)

Use this hierarchy only when an entire component is absent from Generated SAP:
1. Check if element exists in Original SAP
2. If entirely absent from Generated SAP → Check Protocol
3. If element exists in Protocol → **PROBLEM** (missing required element) → classification = `missing_required`
4. If element only exists in Original SAP (not in Protocol) → **ACCEPTABLE** (not required) → classification = `acceptable_difference`

**CLASSIFICATION RULE**: The `classification` field in `missing_from_generated_sap` MUST be:
- `missing_required` → ONLY when `in_protocol` = "yes"
- `acceptable_difference` → ONLY when `in_protocol` = "no"

**When NOT to use Protocol:**
- Component exists in Generated SAP but is shorter/abbreviated → Do NOT check Protocol
- Component exists but omits qualifiers/details → Do NOT check Protocol
- These are CONTENT differences, not EXISTENCE differences

### CHECK 2: CONTENT (What does it say?)

Compare to Original SAP ONLY.

**DO NOT use Protocol to evaluate content differences. Protocol is ONLY for EXISTENCE checks.**

For CONTENT, ask these questions:
1. Does Generated SAP match Original SAP? → **CORRECT**
2. Does Generated SAP omit only minor wording but preserve ALL specifics? → **ACCEPTABLE**
3. Does Generated SAP omit methodological steps, formulas, specific values, or procedural details? → **PROBLEM** (missing_specification)
4. Does Generated SAP contradict Original SAP? → **PROBLEM** (contradiction)

| Scenario | Result |
|----------|--------|
| Generated SAP content matches Original SAP | **CORRECT** |
| Generated SAP has minor wording differences but includes all specifics | **ACCEPTABLE** |
| Original SAP has steps/formulas/values, Generated SAP mentions concept but lacks specifics | **PROBLEM** (missing_specification) |
| Generated SAP says something DIFFERENT that contradicts Original SAP | **PROBLEM** (contradiction) |

**How to distinguish these categories:**
- ACCEPTABLE: Only minor wording omitted (adjectives, qualifiers, clarifying phrases). ALL methodology steps, formulas, and specific values are still present.
- MISSING SPECIFICATION: Original SAP provides HOW (steps, formulas, specific values). Generated SAP only says WHAT (mentions the method/concept but omits the specifics). This is a PROBLEM.
- CONTRADICTION: Generated SAP states something incompatible with Original SAP (cannot both be true)

**For EVERY contradiction, you MUST provide:**
1. FULL VERBATIM quote from Original SAP - do NOT truncate with "..." - include the complete sentence or paragraph
2. FULL VERBATIM quote from Generated SAP - do NOT truncate with "..." - include the complete sentence or paragraph
3. Chain-of-thought reasoning explaining:
   - What Original SAP says (with specific section reference)
   - What Generated SAP says (with specific section reference)
   - Why both statements cannot be true at the same time
   - The specific conflict between them

**QUOTE REQUIREMENT**: All quotes in issues, evaluation_table, and missing_from_generated_sap MUST be COMPLETE. Never use "..." to abbreviate. If a definition spans multiple sentences, include all of them.

---

## EVALUATION RULES

**CRITICAL**: Do not copy text between fields. The original_sap_text must come from the Original SAP document, not from Generated SAP. Quote VERBATIM text from each document first, then compare semantically. Do not paraphrase or summarize. **NEVER truncate quotes with "..." - always provide the COMPLETE text.**

**For ALL content types:**
- Compare to Original SAP first
- If Generated SAP matches Original SAP → CORRECT
- If Generated SAP contradicts Original SAP → PROBLEM
- Check if Original SAP contains any updates or amendments. If Generated SAP uses an old definition instead of the updated one, this is a contradiction

---

## EXTRA INFORMATION HANDLING

Generated SAP may contain definitions not present in Original SAP.

- Extra definitions that do NOT contradict → FLAG as extra, but NEUTRAL (do not penalize)
- Extra definitions that CONTRADICT Original SAP → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: EXTRACTION (from Generated SAP only)

1. Locate the Key Definitions section in the Generated SAP
2. Extract each distinct definition, formula, or variable definition from that section
3. For each extracted item, record the EXACT TEXT (word-for-word quote)
4. Do not paraphrase or summarize
5. Create one entry per definition

**EXTRACTION GRANULARITY:**
Each definition or formula is a separate entry.

**COUNT YOUR ELEMENTS:**
After extraction, count the total number of elements you extracted. Record this number - it will be verified later.

### PHASE 2: COMPARISON AND CLASSIFICATION

**TRACKING RULE:**
Every element extracted in Phase 1 MUST appear in the evaluation_table. No element can be skipped or lost.

**Step A**: For each extracted element from the Generated SAP, search the ENTIRE Original SAP for corresponding content
- Identify the key terms from the Generated SAP element
- Search the ENTIRE Original SAP for those key terms — key definitions may be scattered across multiple sections, not in a single dedicated section
- When found, copy the EXACT sentence word-for-word as original_sap_text
- Do NOT paraphrase, summarize, or reword what you find
- If no corresponding content exists anywhere in the Original SAP, record original_sap_text as null

**MISSING FROM ORIGINAL SAP RULE:** If a definition exists in the Generated SAP but has no corresponding content anywhere in the Original SAP, assume the Generated SAP is correct. Place this item in the evaluation_table with original_sap_text: null, result: "correct", and note it as extra information. Do not penalize.

**Step B**: Compare statements directly

**FORMULA MATCHING RULE:** When the Original SAP contains multiple formulas for related but distinct concepts, you MUST match the Generated SAP formula to the Original SAP formula that calculates the same thing. Do not compare a Generated SAP formula against a different Original SAP formula just because they share similar keywords. Verify that the two formulas are intended to compute the same quantity before declaring a match or contradiction.

**EXPLICIT CONSTANT RULE:** When the Original SAP states an explicit numeric constant to use in a formula, that stated constant is the governing instruction — even if the Original SAP also provides a parenthetical derivation, rationale, or approximation alongside it. The parenthetical is explanatory context, not an alternative value. If the Generated SAP uses a different number than the explicitly stated constant, this is a contradiction.

- Ask: "Can both statements be true at the same time?"
- If YES → matches_original_sap: "yes" (no conflict, statements are compatible)
- If NO → matches_original_sap: "no" (contradiction, statements conflict)

**Step C**: Determine detail_level
- match: Generated SAP text is equivalent to Original SAP text
- less_detailed: Generated SAP omits words/clauses but core meaning preserved
- contradiction: Generated SAP states something incompatible with Original SAP

**Step D**: For less_detailed items, document omissions
- Record exactly what words, clauses, steps, formulas, or values were omitted in `omitted_content`
- Assess `omission_impact`: none | low | potential (could this omission change meaning?)

**Step E**: After completing the evaluation table, check the Original SAP for key definitions that are present in the Original SAP but absent from the Generated SAP. List these in `missing_from_generated_sap` for informational tracking. Missing items do NOT affect the rating.

For each missing item, check Protocol:
- Search the ENTIRE Protocol document for the same element
- Content may be worded differently - look for semantic match
- Record in_protocol: "yes" if concept exists (even if worded differently)
- Record in_protocol: "no" ONLY if concept is truly absent after thorough search

### PHASE 3: OUTPUT COMPLETENESS VERIFICATION

**OUTPUT COMPLETENESS RULE:**
Your evaluation_table must contain exactly the same number of entries as elements_extracted (from Phase 1). The missing_from_generated_sap array is separate and tracks Original SAP content not found in the Generated SAP.

Before generating output:
1. Count your extracted elements from Phase 1
2. Ensure every single one has a corresponding entry in evaluation_table
3. elements_extracted = elements_in_evaluation_table
4. Do NOT consolidate, summarize, or merge entries in the output

If counts do not match, add the missing entries before proceeding.

---

## RATING CRITERIA

Rating is based ONLY on contradictions. Missing information does NOT affect the rating under any circumstances. Missing items are tracked informationally in `missing_from_generated_sap` but do not influence the rating. Do not consider omissions, missing items, or level of detail when determining the rating.

A section with 0 contradictions MUST be rated GREAT, regardless of how many items are missing or omitted.

### GREAT
- No contradictions between Generated SAP and Original SAP
- No contradictions with Protocol
- No internal contradictions
- This is the correct rating even if many items are missing or less detailed

### DECENT
- Minor contradictions that do not affect trial integrity
- Small inconsistencies easily correctable
- No Protocol contradictions

### POOR
- Critical contradictions with Protocol
- Generated SAP states something fundamentally incompatible with Original SAP
- Multiple contradictions
- Internal contradictions

---

## OUTPUT FORMAT

Provide BOTH markdown (for human review) AND JSON (for programmatic use).

---

## MARKDOWN OUTPUT

```markdown
## Key Definitions Evaluation

**Section:** key_definitions
**Rating:** [GREAT | DECENT | POOR]
**Status:** [pass | pass_with_notes | fail]

---

### Evaluation Summary Table

| Component | Evaluation Type | Matches Original SAP | Protocol Consulted | Result | Issue Type | Severity |
|-----------|-----------------|---------------------|-------------------|--------|------------|----------|
| [name] | exact_match / semantic | yes/no | yes/no/n/a | correct/acceptable/problem | none/contradiction | none/minor/critical |

---

### Issues Found

| Issue Type | Severity | Component | Original SAP Text | Generated SAP Text | Why They Conflict | Reasoning |
|------------|----------|-----------|-------------------|--------------------|--------------------|-----------|
| [type] | [severity] | [name] | "[exact quote]" | "[exact quote]" | [why both cannot be true] | [chain-of-thought] |

(If no issues: "*No issues found.*")

---

### Extra Information Flagged

| Content | Generated SAP Text | Contradicts | Detail |
|---------|-------------------|-------------|--------|
| [description] | "[quote]" | yes/no | [explanation] |

(If none: "*No extra information flagged.*")

---

### Missing from Generated SAP (X items)

| Component | Classification | In Protocol | Original SAP Text | Protocol Text | Reasoning |
|-----------|----------------|-------------|-------------------|---------------|-----------|
| [name] | missing_required/acceptable_difference | yes/no | "[quote]" | "[quote]" | [chain-of-thought] |

(If none: "*None - all required content is present.*")

---

### Reasoning

[Step-by-step chain-of-thought reasoning trace]

---

### Summary

[2-3 sentence overall assessment]
```

---

## JSON OUTPUT

```json
{
  "section": "key_definitions",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",
  "extraction_validation": {
    "sections_read": ["list every section/subsection number read from Generated SAP"],
    "elements_per_section": {"section_number": "count of elements extracted from that section of the Generated SAP"},
    "elements_extracted": 0,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "short description",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null",
      "protocol_text": "exact quote, or null if not consulted",
      "protocol_consulted": "yes | no | n/a",
      "matches_original_sap": "yes | no",
      "detail_level": "match | less_detailed | contradiction",
      "omitted_content": "REQUIRED: list specific words, clauses, steps, formulas, or values from Original SAP that are not in Generated SAP. Write 'none' only if exact match.",
      "omission_impact": "none | low | potential (could this omission change meaning?)",
      "result": "correct | acceptable | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "short description",
      "original_sap_text": "exact quote",
      "protocol_text": "exact quote if found, null if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "FULL VERBATIM QUOTE from Original SAP - NO truncation with ... (required)",
      "generated_sap_text": "FULL VERBATIM QUOTE from Generated SAP - NO truncation with ... (required)",
      "protocol_text": "exact quote if relevant",
      "why_they_conflict": "explanation of why both cannot be true at the same time",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought: 1) What Original SAP says, 2) What Generated SAP says, 3) Why these conflict, 4) Why both cannot be true"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

**counts_match MUST be true for valid output.**

Before finalizing your output, verify:
- `elements_extracted` = `elements_in_evaluation_table` (every element extracted from the Generated SAP must have an evaluation_table entry)
- `elements_extracted` = sum of all values in `elements_per_section`
- `missing_from_generated_sap` is a SEPARATE count — it tracks Original SAP content not found in the Generated SAP and does NOT factor into the extraction count
- If the counts do not match, your output is INVALID - go back and find the missing elements

---

## CRITICAL REMINDERS

1. **Extract from Generated SAP**: Locate the Key Definitions section in the Generated SAP and extract every definition, formula, and variable definition from it.
2. **Search entire Original SAP**: For each extracted element, search the ENTIRE Original SAP for corresponding content — key definitions may be scattered across multiple sections.
3. **EXISTENCE vs CONTENT**: Protocol is ONLY for checking if missing elements are required, NOT for evaluating content differences.
4. **Compare to Original SAP first**: For content, always compare Generated SAP to Original SAP.
5. **Contradiction is a problem**: Generated SAP saying something incompatible with Original SAP is a problem.
6. **Extra info is neutral**: Flag but do not penalize extra information unless it contradicts.
7. **Blocking validation**: Ensure counts_match is true before outputting.
8. **Full quotes required**: NEVER use "..." to truncate quotes - always include complete text.
9. **Scope**: ONLY evaluate key definitions, variable definitions, calculation formulas, study period definitions, and operational definitions. Do NOT evaluate analysis populations, study objectives, endpoint definitions, efficacy analysis methods, or general statistical methodology.
10. **Rating based on contradictions only**: Missing information does NOT affect rating. Track missing items informationally but do not penalize.
11. **Match formulas correctly**: When the Original SAP has multiple formulas for related concepts, match each Generated SAP formula to the Original SAP formula that computes the same quantity. Do not compare formulas that calculate different things.
12. **Explicit constants govern**: When the Original SAP states an explicit numeric constant in a formula, that constant is the instruction. A parenthetical derivation or rationale does not override it. If the Generated SAP uses a different number, it is a contradiction.
