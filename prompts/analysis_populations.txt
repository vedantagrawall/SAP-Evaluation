# Analysis Populations Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate the Analysis Population content in the Generated SAP.

**IMPORTANT**: Do not assume which populations exist. Discover all populations present across all three documents by searching each document thoroughly.

---

## EVALUATION HIERARCHY

There are TWO separate checks. Do not conflate them.

### CHECK 1: EXISTENCE (Does the element exist?)

**What is a "missing element"?**
- Missing element = an entire component is completely absent from Generated SAP
- If the component exists in Generated SAP (even if shorter/abbreviated), it is NOT missing

Use this hierarchy only when an entire component is absent:
1. Check if element exists in Original SAP
2. If entirely absent from Generated SAP → Check Protocol
3. If element exists in Protocol → **PROBLEM** (missing required element)
4. If element only exists in Original SAP (not in Protocol) → **ACCEPTABLE** (not required)

**When NOT to use Protocol:**
- Component exists in Generated SAP but is shorter/abbreviated → Do NOT check Protocol
- Component exists but omits qualifiers/details → Do NOT check Protocol
- These are CONTENT differences, not EXISTENCE differences

### CHECK 2: CONTENT (What does it say?)

Compare to Original SAP ONLY.

**DO NOT use Protocol to evaluate content differences. Protocol is ONLY for EXISTENCE checks.**
**DO NOT mention Protocol in your reasoning for content comparisons.**

For CONTENT, ask only these questions:
1. Does Generated SAP match Original SAP? → **CORRECT**
2. Is Generated SAP less detailed than Original SAP? → **ACCEPTABLE** only if the missing detail does NOT change which patients are included/excluded or how they are assigned. If it changes the patients or assignment, it is a different meaning → **PROBLEM**
3. Does Generated SAP contradict Original SAP? → **PROBLEM**
4. Does Generated SAP contain a GAP statement or deferred-definition language? → **ACCEPTABLE**. A GAP statement signals that certain details require future input and cannot be pre-specified. This is not a problem.

Stop. Do not consult Protocol for content. Do not mention Protocol in reasoning.

| Scenario | Result |
|----------|--------|
| Generated SAP content matches Original SAP |  **CORRECT** |
| Generated SAP is less detailed but does NOT change patients or assignment |  **ACCEPTABLE** |
| Generated SAP is less detailed AND changes which patients are included/excluded or how assigned |  **PROBLEM** (different meaning) |
| Generated SAP says something DIFFERENT that contradicts Original SAP |  **PROBLEM** (contradiction) |
| Generated SAP contains a GAP statement or deferred-definition language instead of specific criteria |  **ACCEPTABLE** |

**How to distinguish "less detailed" from "contradiction":**
- Less detailed: Generated SAP omits words/clauses but core meaning is preserved
- Contradiction: Generated SAP states something incompatible with Original SAP (cannot both be true)

**REASONING REQUIREMENT:**
For EVERY component, you MUST provide detailed reasoning that explains:
1. What you found in Original SAP (exact text)
2. What you found in Generated SAP (exact text)
3. How they compare (match, less detailed, or contradiction)
4. If less detailed: what specific words/clauses are omitted
5. If less detailed: could this omission change the meaning? (flag if yes)
6. Your conclusion and why

**FORBIDDEN IN CONTENT REASONING:**
When comparing content (not checking existence), your reasoning must NEVER include:
- "matches Protocol" or "matches the Protocol"
- "Protocol definition" or "Protocol says"
- "consistent with Protocol"
- "aligns with Protocol"
- "Protocol does not require" or "not required by Protocol"
- "Protocol does not explicitly require"
- Any reference to Protocol whatsoever - including when assessing impact

Your content reasoning must ONLY reference Original SAP and Generated SAP. The impact of an omission should be assessed by asking: "Does this omission change the MEANING?" - NOT by asking whether Protocol requires it. Protocol is completely irrelevant to content comparisons and impact assessments.

### Special Cases

| Scenario | Result |
|----------|--------|
| Population in Protocol + Original SAP, but ABSENT from Generated SAP | **PROBLEM** (missing required) |
| Population in Original SAP only (not in Protocol), absent from Generated SAP | **ACCEPTABLE** |
| Generated SAP has extra information that does not contradict | **FLAG** but neutral |
| Generated SAP has extra information that contradicts | **PROBLEM** |

---

## WHAT TO EVALUATE FOR EACH POPULATION

### Critical Components (MUST match)

For each population, evaluate these components:

- **Name** - Must match exactly

- **Definition** - Extract the COMPLETE text from Original SAP that describes which patients are in this population. This includes ALL inclusion criteria AND ALL exclusion criteria together as ONE text. Compare to the COMPLETE definition text in Generated SAP. Meaning = which patients are included/excluded. Different meaning = PROBLEM. Less detail with same meaning = ACCEPTABLE.

- **Treatment Assignment** - Extract the COMPLETE text from Original SAP that describes how patients are assigned to treatment groups. This includes ALL assignment rules together as ONE text. Compare to the COMPLETE assignment text in Generated SAP. Meaning = how patients are assigned. Different meaning = PROBLEM. Less detail with same meaning = ACCEPTABLE.

- Plus any other content within the population's section

**Evaluation logic for these components:**
- If Generated SAP matches Original SAP → CORRECT
- If Generated SAP is less detailed but meaning preserved → ACCEPTABLE
- If Generated SAP contradicts Original SAP → PROBLEM

### All Other Content for Each Population (MUST also be captured)

For any other content in Original SAP beyond the critical components:

1. Check if it exists in Generated SAP
2. If missing from Generated SAP → **Check Protocol**
3. Search Protocol and provide evidence:
   - If found in Protocol → Quote the Protocol text → Missing = **PROBLEM**
   - If NOT found in Protocol → State where you searched → Missing = **ACCEPTABLE**

**You must PROVE you checked Protocol** - either quote what you found, or confirm which sections you searched and found nothing.

---

## DISCOVERY PROCESS

**MANDATORY: Complete discovery BEFORE evaluation. List everything first, then evaluate.**

### Step 1: Search Protocol
- Search the entire Protocol document for analysis populations/analysis sets
- List ALL populations defined
- Record ALL text within each population's section

### Step 2: Search Original SAP
- Search the entire Original SAP document for analysis populations
- List ALL populations defined
- For EACH population, list ALL distinct components found
- Record ALL text within each population's section—every sentence, clause, phrase, list, reference, and statement
- Do not filter or summarize. Extract the complete text.
- **Count the total number of distinct components across all populations**

### Step 3: Search Generated SAP
- Search the entire Generated SAP document for analysis populations
- List ALL populations defined
- For EACH population, list ALL distinct components found
- Record ALL text within each population's section
- **Count the total number of distinct components across all populations**

### Step 4: Create Component Inventory
**Before evaluating, create a complete inventory:**
- List every population found in any document
- For each population, list every distinct component found in Original SAP
- This inventory determines how many evaluation rows you must create
- **Total components extracted = Number of evaluation_table rows + Number of missing_from_generated_sap rows**

### Step 5: Evaluate Each Component
For each component in your inventory:
1. Check if present in Generated SAP (if absent → add to missing_from_generated_sap, then check Protocol for EXISTENCE)
2. If present, compare content to Original SAP ONLY (never consult Protocol for content)
3. Create one evaluation_table row per component that exists in Generated SAP
4. Determine: match, less detailed, or contradiction (comparing to Original SAP only)
5. For missing elements only: Record Protocol text to determine if required

---

## HANDLING ORIGINAL SAP CONTENT NOT IN GENERATED SAP

Separately from the evaluation, you MUST identify ALL content in the Original SAP that is NOT present in the Generated SAP. This is a parallel task, not a secondary one.

### EXHAUSTIVE DOCUMENTATION REQUIREMENT

You MUST capture EVERY piece of content from the Original SAP that does not appear in the Generated SAP. No exceptions. No filtering. No judgment about importance.

### MANDATORY METHODOLOGY

Follow this exact process:

**Step 1: Extract**
- Go through the ENTIRE Original SAP analysis populations section from beginning to end
- Extract EVERY distinct sentence, clause, phrase, and piece of information
- Do not skip anything

**Step 2: Decompose**
- Do NOT compare sentences as wholes
- Break each Original SAP sentence into its individual components: clauses, phrases, qualifiers, modifiers, references, and embedded information
- Each component must be checked separately

**Step 3: Search**
- For EACH component, search the Generated SAP for equivalent content
- Check for both exact matches and semantic equivalents
- If an Original SAP sentence contains information that the Generated SAP sentence omits or shortens, that omission must be documented—even if the "main idea" is preserved

**Step 4: Document and VERIFY Against Protocol**
- If ANY component is NOT found in Generated SAP (neither verbatim nor semantically), add it to `missing_from_generated_sap`
- Document the exact Original SAP text
- **CRITICAL: Actually search the Protocol for this content**
- If found in Protocol: Set `in_protocol: "yes"` and quote the Protocol text in `protocol_text`
- If NOT found in Protocol: Set `in_protocol: "no"` and set `protocol_text` to a verification statement confirming the search was performed
- You must PROVE you checked the Protocol, not just assume
- Describe what is missing
- If a single sentence has multiple missing components, document each one separately
- This includes both entire missing populations AND missing content within populations

**Step 5: Verify Completeness**
- After completing the comparison, re-read the Original SAP section
- Confirm that every sentence, clause, phrase, qualifier, modifier, and reference has been accounted for
- If you find anything not yet documented, add it

### RULES

1. **No filtering**: Do not skip content because it seems minor, trivial, or unimportant
2. **No categorization bias**: Do not skip content because it doesn't fit a predefined category
3. **No semantic shortcuts**: If the Original SAP says something in a specific way and the Generated SAP says it differently or omits it, document it
4. **Capture everything**: Every word, phrase, clause, sentence, list item, reference, and statement that exists in Original SAP but not in Generated SAP must be documented
5. **When in doubt, include it**: If you are unsure whether something is missing, document it
6. **Sub-sentence granularity**: Do not stop at checking whether a sentence exists. Check whether every part of that sentence exists. A sentence with 5 pieces of information requires 5 checks.
7. **Preserved meaning is not enough**: If the Generated SAP captures the "main idea" but omits words, phrases, or clauses from the Original SAP, document what was omitted
8. **Missing information is not a wording difference**: If the Original SAP contains information that the Generated SAP does not contain, that is missing content—not a wording difference. Document it.
9. **One row per component**: Every distinct component must have its own row in either evaluation_table or missing_from_generated_sap. Never combine multiple components into one row.
10. **Validate your counts**: Before outputting, verify that total_components_extracted equals components_in_evaluation_table + components_in_missing_from_generated_sap.

### OUTPUT FIELD

For `content_type` in the JSON output, use a brief descriptive label that accurately describes what the content is. Do not limit yourself to predefined categories.

---

## RATING CRITERIA

### GREAT
- All Protocol-required populations present
- Names match (per evaluation hierarchy)
- Definitions semantically match
- Treatment assignments correct
- No contradictions

### DECENT
- All Protocol-required populations present
- Minor wording differences that do not change meaning
- Small issues easily correctable
- No critical omissions

### POOR
- Protocol-required population completely absent
- Names differ without justification from Protocol
- Definitions have materially different meaning
- Treatment assignment wrong or missing
- Contradictions exist

---

## OUTPUT FORMAT

Provide BOTH markdown (for human review) AND JSON (for programmatic use).

---

## MARKDOWN OUTPUT

```markdown
## Analysis Populations Evaluation

**Section:** analysis_populations
**Rating:** [GREAT | DECENT | POOR]
**Status:** [pass | pass_with_notes | fail]

---

### Evaluation Summary Table

| Component | Evaluation Type | Matches Original SAP | Protocol Consulted | Result | Issue Type | Severity |
|-----------|-----------------|---------------------|-------------------|--------|------------|----------|
| [Population - component] | exact_match / semantic | yes/no | yes/no | correct/acceptable/problem | none/contradiction | none/minor/critical |

---

### Issues Found

| Issue Type | Severity | Component | Why They Conflict | Description |
|------------|----------|-----------|-------------------|-------------|
| [absent/contradiction/incomplete] | [minor/critical] | [name] | [explanation] | [explanation] |

(If no issues: "No issues found.")

---

###  Missing Required Content (X items)

Content in both Original SAP AND Protocol - should be in Generated SAP.

| Component | Type | Description |
|-----------|------|-------------|
| [Population or General] | [descriptive label] | [what is missing] |

(If none: "No missing required content.")

---

### Extra Information in Generated SAP

| Content | Generated SAP Text | Contradicts | Detail | Reasoning |
|---------|-------------------|-------------|--------|-----------|
| [description] | "[quote]" | yes/no | [explanation if contradicts] | [chain-of-thought] |

(If none: "No extra information identified.")

---

### Reasoning

[Step-by-step chain-of-thought reasoning trace:]
1. What populations I found in Original SAP
2. What populations I found in Generated SAP
3. For each component: Original SAP text vs Generated SAP text
4. For each component: match, less detailed, or contradiction
5. For less detailed items: what is omitted and could it change meaning
6. For missing items: checked Protocol for existence (required or not)
7. Why this rating was assigned

---

### Summary

[2-3 sentence overall assessment]
```

---

## JSON OUTPUT

```json
{
  "section": "analysis_populations",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "extraction_validation": {
    "populations_found": ["list every population discovered"],
    "components_per_population": {"Population Name": "count of distinct components"},
    "total_components_extracted": 0,
    "components_in_evaluation_table": 0,
    "components_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "Population Name - component",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote (or null if absent)",
      "protocol_text": "exact quote or null",
      "protocol_consulted": "yes | no",
      "matches_original_sap": "yes | no",
      "detail_level": "match | less_detailed | contradiction",
      "omitted_content": "what specific words/clauses are omitted (null if match)",
      "omission_impact": "none | low | potential (could this omission change meaning?)",
      "result": "correct | acceptable | problem",
      "issue_type": "none | contradiction",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought: 1) Original SAP says [X], 2) Generated SAP says [Y], 3) Comparison: [match/less detailed/contradiction], 4) If less detailed: omitted [Z], impact: [none/low/potential], 5) Conclusion based on Original SAP comparison only (NEVER mention Protocol here)"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "Population Name or General",
      "content_type": "entire_population | descriptive label for content type",
      "original_sap_text": "exact quote of what Original SAP contains",
      "protocol_text": "REQUIRED: exact quote if found, OR 'Searched Protocol section X - not found' if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing from Generated SAP",
      "reasoning": "Chain-of-thought: 1) What Original SAP says, 2) What Protocol says (or doesn't say), 3) Why this classification, 4) Impact of omission on analysis"
    }
  ],

  "issues": [
    {
      "issue_type": "absent | contradiction | incomplete",
      "severity": "minor | critical",
      "component": "Population Name - component",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null if absent",
      "protocol_text": "exact quote",
      "why_they_conflict": "explanation of why both cannot be true",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought: 1) What the issue is, 2) How I identified it, 3) What each document says, 4) Why this severity level, 5) Impact on analysis"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought: 1) What extra content I found, 2) Where it appears in Generated SAP, 3) Whether it exists in Original SAP or Protocol, 4) Why it contradicts or not"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace: 1) What populations I found in Protocol, 2) What populations I found in Original SAP, 3) What populations I found in Generated SAP, 4) How I compared content (Original SAP only), 5) How I checked existence (Protocol for missing elements only), 6) What is less detailed vs what contradicts, 7) Why this rating was assigned",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

**counts_match MUST be true for valid output.**

Before finalizing your output, verify:
- `total_components_extracted` = `components_in_evaluation_table` + `components_in_missing_from_generated_sap`
- If the counts do not match, your output is INVALID - go back and find the missing components

This ensures no component is skipped or lost during evaluation.

---

## CRITICAL REMINDERS

1. **Discovery first**: Do not assume populations exist - search and find them in each document
2. **Protocol is for EXISTENCE only, never for CONTENT**: Do not use Protocol to excuse content differences
3. **For CONTENT**: Compare Generated SAP to Original SAP only - is it a match, less detailed, or contradiction?
4. **For EXISTENCE**: Use Protocol only to check if a missing element is required
5. **Less detailed is acceptable**: If Generated SAP omits words but preserves meaning, that is ACCEPTABLE
6. **Contradiction is a problem**: If Generated SAP says something incompatible with Original SAP, that is a PROBLEM
7. **Absence is only a problem if required by Protocol**: Missing a population that Protocol defines is a PROBLEM; missing one only in Original SAP is not
8. **Do not split Definition or Treatment Assignment**: Evaluate each as ONE complete text. Include all inclusion/exclusion criteria in Definition. Include all assignment rules in Treatment Assignment. Do not put parts of Definition or Treatment Assignment in missing_from_generated_sap - evaluate them together.
9. **Quote actual text**: Always provide exact quotes from documents
10. **Blocking validation**: Ensure counts_match is true before outputting - total_components_extracted must equal components_in_evaluation_table + components_in_missing_from_generated_sap
11. **NEVER mention Protocol in content reasoning**: Your reasoning for content comparisons must only reference Original SAP and Generated SAP. Writing "matches Protocol" or similar in content reasoning is WRONG.
