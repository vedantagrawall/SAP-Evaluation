# Analysis Populations Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate the Analysis Population content in the Generated SAP.

**IMPORTANT**: Do not assume which populations exist. Discover all populations present across all three documents by searching each document thoroughly.

---

## EVALUATION HIERARCHY

Follow this order strictly:

1. **Compare Generated SAP to Original SAP first**
2. **If they match** → CORRECT, no further investigation needed
3. **If they differ** → Go to Protocol as tiebreaker
4. **If Generated SAP matches Protocol** → CORRECT (do not penalize, even if Original SAP differs)
5. **If Generated SAP matches neither Original SAP nor Protocol** → PROBLEM

### Special Cases

| Scenario | Result |
|----------|--------|
| Population in Protocol + Original SAP, but ABSENT from Generated SAP | **PROBLEM** (absence) |
| Population in Original SAP only (not in Protocol), absent from Generated SAP | **NOT A PROBLEM** |
| Extra detail in Original SAP not in Protocol, omitted by Generated SAP | **NOT A PROBLEM** |
| Extra information in Generated SAP that does not contradict | **FLAG** but neutral (not a problem) |
| Extra information in Generated SAP that contradicts | **PROBLEM** |

---

## WHAT TO EVALUATE FOR EACH POPULATION

For each analysis population, evaluate THREE components:

| Component | Evaluation Type | Comparison Rule |
|-----------|-----------------|-----------------|
| **Name** | exact_match | Compare to Original SAP first; if different, check Protocol as tiebreaker |
| **Definition** | semantic | Compare to Original SAP first; if different, check Protocol as tiebreaker |
| **Treatment Assignment** | semantic | Compare to Original SAP first; if different, check Protocol as tiebreaker |

**All three components follow the same evaluation hierarchy:**
1. If Generated SAP matches Original SAP → CORRECT
2. If Generated SAP differs from Original SAP → Consult Protocol
3. If Generated SAP matches Protocol → CORRECT (even if Original SAP differs)
4. If Generated SAP matches neither → PROBLEM

---

## DISCOVERY PROCESS

### Step 1: Search Protocol
- Search the entire Protocol document for analysis populations/analysis sets
- List ALL populations defined
- Record ALL text related to each population

### Step 2: Search Original SAP
- Search the entire Original SAP document for analysis populations
- List ALL populations defined
- Record ALL text related to each population—every sentence, clause, phrase, list, reference, and statement
- Do not filter or summarize. Extract the complete text.

### Step 3: Search Generated SAP
- Search the entire Generated SAP document for analysis populations
- List ALL populations defined
- Record ALL text related to each population

### Step 4: Evaluate Each Population

For each population found in Protocol:
1. Check if present in Generated SAP (if absent → PROBLEM)
2. Compare name (exact_match)
3. Compare definition (semantic)
4. Compare treatment assignment (semantic)
5. If Generated SAP differs from Original SAP → consult Protocol
6. Record Protocol text when consulted

---

## HANDLING ORIGINAL SAP CONTENT NOT IN GENERATED SAP

Separately from the evaluation, you MUST identify ALL content in the Original SAP that is NOT present in the Generated SAP. This is a parallel task, not a secondary one.

### EXHAUSTIVE DOCUMENTATION REQUIREMENT

You MUST capture EVERY piece of content from the Original SAP that does not appear in the Generated SAP. No exceptions. No filtering. No judgment about importance.

### MANDATORY METHODOLOGY

Follow this exact process:

**Step 1: Extract**
- Go through the ENTIRE Original SAP analysis populations section from beginning to end
- Extract EVERY distinct sentence, clause, phrase, and piece of information
- Do not skip anything

**Step 2: Decompose**
- Do NOT compare sentences as wholes
- Break each Original SAP sentence into its individual components: clauses, phrases, qualifiers, modifiers, references, and embedded information
- Each component must be checked separately

**Step 3: Search**
- For EACH component, search the Generated SAP for equivalent content
- Check for both exact matches and semantic equivalents
- If an Original SAP sentence contains information that the Generated SAP sentence omits or shortens, that omission must be documented—even if the "main idea" is preserved

**Step 4: Document**
- If ANY component is NOT found in Generated SAP (neither verbatim nor semantically), add it to `missing_from_generated_sap`
- Document the exact Original SAP text
- Note whether it appears in Protocol (yes/no)
- Describe what is missing
- If a single sentence has multiple missing components, document each one separately
- This includes both entire missing populations AND missing content within populations

**Step 5: Verify Completeness**
- After completing the comparison, re-read the Original SAP section
- Confirm that every sentence, clause, phrase, qualifier, modifier, and reference has been accounted for
- If you find anything not yet documented, add it

### RULES

1. **No filtering**: Do not skip content because it seems minor, trivial, or unimportant
2. **No categorization bias**: Do not skip content because it doesn't fit a predefined category
3. **No semantic shortcuts**: If the Original SAP says something in a specific way and the Generated SAP says it differently or omits it, document it
4. **Capture everything**: Every word, phrase, clause, sentence, list item, reference, and statement that exists in Original SAP but not in Generated SAP must be documented
5. **When in doubt, include it**: If you are unsure whether something is missing, document it
6. **Sub-sentence granularity**: Do not stop at checking whether a sentence exists. Check whether every part of that sentence exists. A sentence with 5 pieces of information requires 5 checks.
7. **Preserved meaning is not enough**: If the Generated SAP captures the "main idea" but omits words, phrases, or clauses from the Original SAP, document what was omitted
8. **Missing information is not a wording difference**: If the Original SAP contains information that the Generated SAP does not contain, that is missing content—not a wording difference. Document it.

### OUTPUT FIELD

For `content_type` in the JSON output, use a brief descriptive label that accurately describes what the content is. Do not limit yourself to predefined categories.

---

## RATING CRITERIA

### GREAT
- All Protocol-required populations present
- Names match (per evaluation hierarchy)
- Definitions semantically match
- Treatment assignments correct
- No contradictions

### DECENT
- All Protocol-required populations present
- Minor wording differences that do not change meaning
- Small issues easily correctable
- No critical omissions

### POOR
- Protocol-required population completely absent
- Names differ without justification from Protocol
- Definitions have materially different meaning
- Treatment assignment wrong or missing
- Contradictions exist

---

## OUTPUT FORMAT

Provide BOTH markdown (for human review) AND JSON (for programmatic use).

---

## MARKDOWN OUTPUT

```markdown
## Analysis Populations Evaluation

**Section:** analysis_populations
**Rating:** [GREAT | DECENT | POOR]
**Status:** [pass | pass_with_notes | fail]

---

### Evaluation Summary Table

| Component | Evaluation Type | Original SAP Text | Generated SAP Text | Protocol Text | Matches Original | Protocol Consulted | Result | Issue Type | Severity | Reasoning |
|-----------|-----------------|-------------------|--------------------|--------------|-----------------|--------------------|--------|------------|----------|-----------|
| [Population - component] | exact_match / semantic | "[quote]" | "[quote]" | "[quote]" | yes/no | yes/no/n/a | correct/problem | none/absent/contradiction/incomplete | none/minor/critical | [chain-of-thought] |

---

### Issues Found

| Issue Type | Severity | Component | Original SAP Text | Generated SAP Text | Protocol Text | Description | Reasoning |
|------------|----------|-----------|-------------------|--------------------|--------------| -------------|-----------|
| [absent/contradiction/incomplete] | [minor/critical] | [name] | "[quote]" | "[quote]" | "[quote]" | [explanation] | [chain-of-thought] |

(If no issues: "No issues found.")

---

### ✅ Acceptable Differences (X items)

Content in Original SAP only (not in Protocol) - acceptable to omit.

| Component | Type | Description |
|-----------|------|-------------|
| [Population or General] | [descriptive label] | [what is missing] |

<details>
<summary>Reasoning</summary>

- **[Component]**: [reasoning for why this is acceptable]
- **[Component]**: [reasoning]

</details>

(If none: "No differences found.")

---

### ❌ Missing Required Content (X items)

Content in both Original SAP AND Protocol - should be in Generated SAP.

| Component | Type | Description |
|-----------|------|-------------|
| [Population or General] | [descriptive label] | [what is missing] |

(If none: "No missing required content.")

---

### ⚠️ Protocol Content Not In Generated SAP (X items)

Content in Protocol but not in Generated SAP.

| Component | Content Type | Protocol Text | Description |
|-----------|--------------|---------------|-------------|
| [Population or General] | [descriptive label] | "[quote]" | [what is missing] |

(If none: "No protocol content missing.")

---

### Extra Information in Generated SAP

| Content | Generated SAP Text | Contradicts | Detail | Reasoning |
|---------|-------------------|-------------|--------|-----------|
| [description] | "[quote]" | yes/no | [explanation if contradicts] | [chain-of-thought] |

(If none: "No extra information identified.")

---

### Reasoning

[Step-by-step chain-of-thought reasoning trace:]
1. What populations I found in Protocol
2. What populations I found in Original SAP
3. What populations I found in Generated SAP
4. How I compared each population (Original SAP first, then Protocol as tiebreaker)
5. Where differences were found
6. When Protocol was consulted and what it said
7. Why this rating was assigned

---

### Summary

[2-3 sentence overall assessment]
```

---

## JSON OUTPUT

```json
{
  "section": "analysis_populations",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "evaluation_table": [
    {
      "component": "Population Name - component",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote (or null if absent)",
      "protocol_text": "exact quote, or null if not consulted",
      "matches_original_sap": "yes | no",
      "protocol_consulted": "yes | no | n/a",
      "result": "correct | problem",
      "issue_type": "none | absent | contradiction | incomplete",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought: 1) What I found in Original SAP, 2) What I found in Generated SAP, 3) Whether they match semantically, 4) If not, what Protocol says, 5) Why this result"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "Population Name or General",
      "content_type": "entire_population | descriptive label for content type",
      "original_sap_text": "exact quote of what Original SAP contains",
      "in_protocol": "yes | no (yes = PROBLEM, no = acceptable difference)",
      "description": "explanation of what is missing from Generated SAP",
      "reasoning": "Chain-of-thought: 1) What I found in Original SAP, 2) How I searched for it in Generated SAP, 3) Why it is considered absent"
    }
  ],

  "protocol_content_not_in_generated_sap": [
    {
      "component": "Population Name or General",
      "content_type": "descriptive label for content type",
      "protocol_text": "exact quote from Protocol",
      "description": "explanation of what is missing from Generated SAP"
    }
  ],

  "issues": [
    {
      "issue_type": "absent | contradiction | incomplete",
      "severity": "minor | critical",
      "component": "Population Name - component",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null if absent",
      "protocol_text": "exact quote",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought: 1) What the issue is, 2) How I identified it, 3) What each document says, 4) Why this severity level, 5) Impact on analysis"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought: 1) What extra content I found, 2) Where it appears in Generated SAP, 3) Whether it exists in Original SAP or Protocol, 4) Why it contradicts or not"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace: 1) What populations I found in Protocol, 2) What populations I found in Original SAP, 3) What populations I found in Generated SAP, 4) How I compared each population (Original SAP first, then Protocol as tiebreaker), 5) Where differences were found, 6) When Protocol was consulted and what it said, 7) Why this rating was assigned",

  "summary": "2-3 sentence overall assessment"
}
```

---

## CRITICAL REMINDERS

1. **Discovery first**: Do not assume populations exist - search and find them in each document
2. **Compare to Original SAP first**: Always compare Generated SAP to Original SAP before consulting Protocol
3. **Protocol is tiebreaker**: Only consult Protocol when Generated SAP differs from Original SAP
4. **Do not penalize Protocol compliance**: If Generated SAP matches Protocol but not Original SAP, that is CORRECT
5. **Document everything**: Include actual text quotes for audit trail
6. **Absence is only a problem if required by Protocol**: Missing a population that Protocol defines is a PROBLEM; missing one only in Original SAP is not
7. **Three components per population**: Always evaluate name, definition, and treatment assignment for each population
8. **Location flexibility**: Content may appear in different sections across documents - search entire documents
9. **Quote actual text**: Always provide exact quotes from documents
10. **Explain Protocol consultations**: When you consult Protocol, document what it says and how it resolved the discrepancy
