# Efficacy Analysis Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Identify every efficacy endpoint in the Generated SAP that has its own dedicated analysis subsection with methodology details (model specification, covariates, sensitivity analyses, missing data handling, etc.). Do not include endpoints that are merely listed or named without analysis methodology.

For **each** such endpoint, evaluate exactly **3 components**:

1. **Endpoint Name** — What is the endpoint called?
2. **Endpoint Definition** — How is the endpoint calculated or measured?
3. **Analysis Method** — Everything the Original SAP specifies about how this endpoint is analyzed. Extract the complete analysis methodology, not just the primary statistical model.

Find the corresponding content in the Original SAP for these same 3 components per endpoint and compare.

---

## EVALUATION HIERARCHY

There are TWO separate checks. Do not conflate them.

### CHECK 1: EXISTENCE (Does the element exist?)

Use this hierarchy only when a component is absent from Generated SAP:
1. Check if element exists in Original SAP
2. If entirely absent from Generated SAP → Check Protocol
3. If element exists in Protocol → **PROBLEM** (missing required element) → classification = `missing_required`
4. If element only exists in Original SAP (not in Protocol) → **ACCEPTABLE** (not required) → classification = `acceptable_difference`

**CLASSIFICATION RULE**: The `classification` field in `missing_from_generated_sap` MUST be:
- `missing_required` → ONLY when `in_protocol` = "yes"
- `acceptable_difference` → ONLY when `in_protocol` = "no"

**When NOT to use Protocol:**
- Component exists in Generated SAP but is shorter/abbreviated → Do NOT check Protocol
- Component exists but omits qualifiers/details → Do NOT check Protocol
- These are CONTENT differences, not EXISTENCE differences

### CHECK 2: CONTENT (What does it say?)

Compare to Original SAP ONLY.

**DO NOT use Protocol to evaluate content differences. Protocol is ONLY for EXISTENCE checks.**

For CONTENT, ask these questions:
1. Does Generated SAP match Original SAP? → **CORRECT**
2. Does Generated SAP omit only minor wording but preserve ALL specifics? → **ACCEPTABLE**
3. Does Generated SAP omit methodological steps, formulas, specific values, or procedural details? → **PROBLEM** (missing_specification). Each distinct omitted element must be listed separately in `missing_from_generated_sap`. Do NOT dismiss omissions because they are absent from the Protocol — this is a content comparison against the Original SAP only.
4. Does Generated SAP contradict Original SAP? → **PROBLEM** (contradiction)

| Scenario | Result |
|----------|--------|
| Generated SAP content matches Original SAP | **CORRECT** |
| Generated SAP has minor wording differences but includes all specifics | **ACCEPTABLE** |
| Original SAP has steps/formulas/values, Generated SAP mentions concept but lacks specifics | **PROBLEM** (missing_specification) |
| Generated SAP says something DIFFERENT that contradicts Original SAP | **PROBLEM** (contradiction) |

**For EVERY contradiction, you MUST provide:**
1. FULL VERBATIM quote from Original SAP - do NOT truncate with "..." - include the complete sentence or paragraph
2. FULL VERBATIM quote from Generated SAP - do NOT truncate with "..." - include the complete sentence or paragraph
3. Chain-of-thought reasoning explaining why both statements cannot be true at the same time

**QUOTE REQUIREMENT**: All quotes in issues, evaluation_table, and missing_from_generated_sap MUST be COMPLETE. Never use "..." to abbreviate.

---

## EVALUATION RULES

**CRITICAL**: Do not copy text between fields. The original_sap_text must come from the Original SAP document, not from Generated SAP. Quote VERBATIM text from each document first, then compare semantically. Do not paraphrase or summarize. **NEVER truncate quotes with "..." - always provide the COMPLETE text.**

**For ALL content types:**
- Compare to Original SAP first
- If Generated SAP matches Original SAP → CORRECT
- If Generated SAP contradicts Original SAP → PROBLEM
- Check if Original SAP contains any updates or amendments. If Generated SAP uses an old definition instead of the updated one, this is a contradiction

---

## EXTRA INFORMATION HANDLING

Generated SAP may contain information not present in Original SAP.

- Extra information that does NOT contradict → FLAG as extra, but NEUTRAL (do not penalize)
- Extra information that CONTRADICTS Original SAP → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: IDENTIFY ALL ENDPOINTS WITH ANALYSIS METHODOLOGY

1. Read the Generated SAP's efficacy section and identify every endpoint that has a dedicated analysis subsection containing methodology details (not just a name or one-line mention)
2. Record each endpoint's name and its section/subsection number in the Generated SAP
3. For each identified endpoint, locate the matching endpoint by name in the Original SAP
4. For each endpoint, extract exactly 3 components from the Original SAP:
   - **Endpoint Name**: The name/label of the endpoint
   - **Endpoint Definition**: How the endpoint is defined, calculated, or measured
   - **Analysis Method**: Everything the Original SAP specifies about how this endpoint is analyzed — the complete analysis methodology, not just the primary statistical model

### PHASE 2: COMPARISON AND CLASSIFICATION

For each endpoint identified in Phase 1, evaluate its 3 components. Tag every evaluation_table entry with the endpoint name so results are grouped by endpoint.

For each component:

**Step A**: Search Generated SAP for the matching content
- Copy the EXACT text word-for-word as generated_sap_text
- Only record null if no matching content exists

**Step B**: Compare statements directly

**FORMULA MATCHING RULE:** When the Original SAP contains multiple formulas for related but distinct concepts, you MUST match the Generated SAP formula to the Original SAP formula that calculates the same thing. Do not compare a Generated SAP formula against a different Original SAP formula just because they share similar keywords. Verify that the two formulas are intended to compute the same quantity before declaring a match or contradiction.

**FORMULA DECOMPOSITION RULE:** When the Endpoint Definition or Analysis Method component contains a formula in either the Original SAP or Generated SAP, you MUST produce a `formula_decomposition` array in the corresponding evaluation_table entry. This is a mandatory structured output — do not skip it. If no formula is present, set `formula_decomposition` to an empty array.

For each formula found, create one object in the `formula_decomposition` array with these fields:
- `formula_original`: The verbatim formula from the Original SAP (or null if absent)
- `formula_generated`: The verbatim formula from the Generated SAP (or null if absent)
- `components`: An array of objects, one per structural component, each with:
  - `component_type`: One of "operand", "operator", "constant", "adjustment"
  - `original_value`: The value in the Original SAP formula (or null)
  - `generated_value`: The value in the Generated SAP formula (or null)
  - `match`: "yes" if identical, "no" if different or missing

Every operand, every operator, every numeric constant, and every additive or subtractive offset must have its own entry. After producing this decomposition, check every row where `match` is "no" — each one is a separate contradiction that must appear in the issues array.

**EXPLICIT CONSTANT RULE:** When the Original SAP states an explicit numeric constant to use in a formula, that stated constant is the governing instruction — even if the Original SAP also provides a parenthetical derivation, rationale, or approximation alongside it. The parenthetical is explanatory context, not an alternative value. If the Generated SAP uses a different number than the explicitly stated constant (whether derived from the parenthetical or from any other source), this is a contradiction with the Original SAP's explicit instruction. Do not invoke any other rule to override this. The stated constant always governs.

**CONTRADICTION VS MISSING DISTINCTION:** A contradiction requires the Generated SAP to actively state something incompatible with the Original SAP. If the Generated SAP is silent on a topic — it does not mention it at all — that is a missing item, not a contradiction. Only flag as contradiction when both documents address the same topic and their statements cannot both be true at the same time.

- Ask: "Can both statements be true at the same time?"
- If YES → matches_original_sap: "yes"
- If NO → matches_original_sap: "no" (contradiction)

**Step C**: Determine detail_level
- match: Generated SAP text is equivalent to Original SAP text
- less_detailed: Generated SAP omits words/clauses but core meaning preserved
- contradiction: Generated SAP states something incompatible with Original SAP

**Step D**: For less_detailed items, document omissions
- Record exactly what was omitted in `omitted_content`
- Assess `omission_impact`: none | low | potential

**Step E**: For missing items, check Protocol
- Search the ENTIRE Protocol document for the same element
- Record in_protocol: "yes" if concept exists (even if worded differently)
- Record in_protocol: "no" ONLY if concept is truly absent

### PHASE 3: OUTPUT COMPLETENESS VERIFICATION

Your evaluation_table must contain exactly (number of endpoints identified) × 3 entries — 3 components per endpoint. The missing_from_generated_sap array is separate and tracks Original SAP content not found in the Generated SAP.

---

## RATING CRITERIA

Rating is based ONLY on contradictions. Missing information does NOT affect the rating under any circumstances. Do not consider omissions, missing items, or level of detail when determining the rating.

A section with 0 contradictions MUST be rated GREAT, regardless of how many items are missing or omitted.

### GREAT
- No contradictions between Generated SAP and Original SAP
- No contradictions with Protocol
- No internal contradictions
- This is the correct rating even if many items are missing or less detailed

### DECENT
- Minor contradictions that do not affect trial integrity
- Small inconsistencies easily correctable
- No Protocol contradictions

### POOR
- Critical contradictions with Protocol
- Generated SAP states something fundamentally incompatible with Original SAP
- Multiple contradictions
- Internal contradictions

---

## JSON OUTPUT

```json
{
  "section": "efficacy_analysis",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "endpoints_evaluated": ["list of all endpoint names evaluated"],

  "extraction_validation": {
    "sections_read": ["list section/subsection numbers consulted in Original SAP"],
    "endpoints_found": 0,
    "elements_per_endpoint": 3,
    "elements_extracted": 0,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "endpoint": "name of the endpoint this entry belongs to",
      "component": "Endpoint Name | Endpoint Definition | Analysis Method",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null",
      "protocol_text": "exact quote, or null if not consulted",
      "protocol_consulted": "yes | no | n/a",
      "matches_original_sap": "yes | no",
      "detail_level": "match | less_detailed | contradiction",
      "omitted_content": "list specific omissions or 'none'",
      "omission_impact": "none | low | potential",
      "result": "correct | acceptable | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation",
      "formula_decomposition": [
        {
          "formula_original": "verbatim formula from Original SAP or null",
          "formula_generated": "verbatim formula from Generated SAP or null",
          "components": [
            {
              "component_type": "operand | operator | constant | adjustment",
              "original_value": "value in Original SAP formula or null",
              "generated_value": "value in Generated SAP formula or null",
              "match": "yes | no"
            }
          ]
        }
      ]
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "short description",
      "original_sap_text": "exact quote",
      "protocol_text": "exact quote if found, null if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "FULL VERBATIM QUOTE - NO truncation",
      "generated_sap_text": "FULL VERBATIM QUOTE - NO truncation",
      "protocol_text": "exact quote if relevant",
      "why_they_conflict": "explanation of why both cannot be true",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

**counts_match MUST be true for valid output.**

Before finalizing your output, verify:
- `elements_extracted` = `endpoints_found` × 3
- `elements_extracted` = `elements_in_evaluation_table` + `elements_in_missing_from_generated_sap`
- Every endpoint in `endpoints_evaluated` must have exactly 3 entries across evaluation_table and missing_from_generated_sap
- If counts do not match, your output is INVALID

---

## CRITICAL REMINDERS

1. **All endpoints with methodology**: Identify every endpoint in the Generated SAP that has a dedicated analysis subsection with methodology details. Evaluate all of them, not just one.
2. **Three components per endpoint**: Endpoint Name, Endpoint Definition, Analysis Method — for each endpoint.
3. **No assumptions**: Do not assume what the endpoints should be. Read them from the Generated SAP. Only include endpoints that have actual analysis methodology written out, not endpoints that are merely listed by name.
4. **EXISTENCE vs CONTENT**: Protocol is ONLY for checking if missing elements are required, NOT for evaluating content differences.
5. **Compare to Original SAP first**: For content, always compare Generated SAP to Original SAP.
6. **Contradiction is a problem**: Generated SAP saying something incompatible with Original SAP is a problem.
7. **Extra info is neutral**: Flag but do not penalize extra information unless it contradicts.
8. **Full quotes required**: NEVER use "..." to truncate quotes - always include complete text.
9. **Rating based on contradictions only**: Missing information does NOT affect rating. Track missing items informationally but do not penalize.
10. **Match formulas correctly**: When the Original SAP has multiple formulas for related concepts, match each Generated SAP formula to the Original SAP formula that computes the same quantity. Do not compare formulas that calculate different things.
11. **Explicit constants govern**: When the Original SAP states an explicit numeric constant in a formula, that constant is the instruction. A parenthetical derivation or rationale does not override it. If the Generated SAP uses a different number, it is a contradiction.
12. **Decompose formulas**: You must list out every operand, operator, constant, and adjustment in each formula before comparing. Flag each differing component separately.
13. **Silence is not contradiction**: If the Generated SAP does not mention a topic at all, that is missing — not a contradiction. A contradiction requires both documents to address the same topic with incompatible statements.
