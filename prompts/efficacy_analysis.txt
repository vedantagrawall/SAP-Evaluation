# Efficacy Analysis Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate ONLY the first efficacy endpoint that appears in the Generated SAP. The Generated SAP is an abbreviated document designed to contain a single efficacy endpoint. Do NOT evaluate every endpoint or every sentence in the efficacy sections. Focus on the first one only.

For that single endpoint, evaluate exactly **3 components**:

1. **Endpoint Name** — What is the endpoint called?
2. **Endpoint Definition** — How is the endpoint calculated or measured?
3. **Analysis Method** — What statistical approach is used to analyze it?

Find the corresponding content in the Original SAP for these same 3 components and compare.

---

## EVALUATION HIERARCHY

There are TWO separate checks. Do not conflate them.

### CHECK 1: EXISTENCE (Does the element exist?)

Use this hierarchy only when a component is absent from Generated SAP:
1. Check if element exists in Original SAP
2. If entirely absent from Generated SAP → Check Protocol
3. If element exists in Protocol → **PROBLEM** (missing required element) → classification = `missing_required`
4. If element only exists in Original SAP (not in Protocol) → **ACCEPTABLE** (not required) → classification = `acceptable_difference`

**CLASSIFICATION RULE**: The `classification` field in `missing_from_generated_sap` MUST be:
- `missing_required` → ONLY when `in_protocol` = "yes"
- `acceptable_difference` → ONLY when `in_protocol` = "no"

**When NOT to use Protocol:**
- Component exists in Generated SAP but is shorter/abbreviated → Do NOT check Protocol
- Component exists but omits qualifiers/details → Do NOT check Protocol
- These are CONTENT differences, not EXISTENCE differences

### CHECK 2: CONTENT (What does it say?)

Compare to Original SAP ONLY.

**DO NOT use Protocol to evaluate content differences. Protocol is ONLY for EXISTENCE checks.**

For CONTENT, ask these questions:
1. Does Generated SAP match Original SAP? → **CORRECT**
2. Does Generated SAP omit only minor wording but preserve ALL specifics? → **ACCEPTABLE**
3. Does Generated SAP omit methodological steps, formulas, specific values, or procedural details? → **PROBLEM** (missing_specification)
4. Does Generated SAP contradict Original SAP? → **PROBLEM** (contradiction)

| Scenario | Result |
|----------|--------|
| Generated SAP content matches Original SAP | **CORRECT** |
| Generated SAP has minor wording differences but includes all specifics | **ACCEPTABLE** |
| Original SAP has steps/formulas/values, Generated SAP mentions concept but lacks specifics | **PROBLEM** (missing_specification) |
| Generated SAP says something DIFFERENT that contradicts Original SAP | **PROBLEM** (contradiction) |

**For EVERY contradiction, you MUST provide:**
1. FULL VERBATIM quote from Original SAP - do NOT truncate with "..." - include the complete sentence or paragraph
2. FULL VERBATIM quote from Generated SAP - do NOT truncate with "..." - include the complete sentence or paragraph
3. Chain-of-thought reasoning explaining why both statements cannot be true at the same time

**QUOTE REQUIREMENT**: All quotes in issues, evaluation_table, and missing_from_generated_sap MUST be COMPLETE. Never use "..." to abbreviate.

---

## EVALUATION RULES

**CRITICAL**: Do not copy text between fields. The original_sap_text must come from the Original SAP document, not from Generated SAP. Quote VERBATIM text from each document first, then compare semantically. Do not paraphrase or summarize. **NEVER truncate quotes with "..." - always provide the COMPLETE text.**

**For ALL content types:**
- Compare to Original SAP first
- If Generated SAP matches Original SAP → CORRECT
- If Generated SAP contradicts Original SAP → PROBLEM
- Check if Original SAP contains any updates or amendments. If Generated SAP uses an old definition instead of the updated one, this is a contradiction

---

## EXTRA INFORMATION HANDLING

Generated SAP may contain information not present in Original SAP.

- Extra information that does NOT contradict → FLAG as extra, but NEUTRAL (do not penalize)
- Extra information that CONTRADICTS Original SAP → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: IDENTIFY THE FIRST EFFICACY ENDPOINT

1. Read the Generated SAP and find the **first efficacy endpoint** mentioned (whether labeled primary, secondary, or otherwise — just take whatever appears first)
2. Record its name
3. In the Original SAP, locate the matching endpoint by name
4. Extract exactly 3 components from the Original SAP for this endpoint:
   - **Endpoint Name**: The name/label of the endpoint
   - **Endpoint Definition**: How the endpoint is defined, calculated, or measured
   - **Analysis Method**: The statistical method used to analyze the endpoint

### PHASE 2: COMPARISON AND CLASSIFICATION

For each of the 3 components:

**Step A**: Search Generated SAP for the matching content
- Copy the EXACT text word-for-word as generated_sap_text
- Only record null if no matching content exists

**Step B**: Compare statements directly
- Ask: "Can both statements be true at the same time?"
- If YES → matches_original_sap: "yes"
- If NO → matches_original_sap: "no" (contradiction)

**Step C**: Determine detail_level
- match: Generated SAP text is equivalent to Original SAP text
- less_detailed: Generated SAP omits words/clauses but core meaning preserved
- contradiction: Generated SAP states something incompatible with Original SAP

**Step D**: For less_detailed items, document omissions
- Record exactly what was omitted in `omitted_content`
- Assess `omission_impact`: none | low | potential

**Step E**: For missing items, check Protocol
- Search the ENTIRE Protocol document for the same element
- Record in_protocol: "yes" if concept exists (even if worded differently)
- Record in_protocol: "no" ONLY if concept is truly absent

### PHASE 3: OUTPUT COMPLETENESS VERIFICATION

Your output arrays (evaluation_table + missing_from_generated_sap) must contain exactly 3 entries total (one per component).

---

## RATING CRITERIA

### GREAT
- All 3 components present and match Original SAP
- No contradictions

### DECENT
- All 3 components present
- Minor wording differences that do not change meaning

### POOR
- A component is missing and required
- Content contradicts Original SAP

**RATING RULE**: If ANY item has `classification: "missing_required"`, the rating MUST be POOR. If ANY item has a contradiction, the rating MUST be POOR.

---

## JSON OUTPUT

```json
{
  "section": "efficacy_analysis",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "endpoint_evaluated": "the name of the first efficacy endpoint found in Generated SAP",

  "extraction_validation": {
    "sections_read": ["list section/subsection numbers consulted in Original SAP"],
    "elements_per_section": {"component_name": 1},
    "elements_extracted": 3,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "Endpoint Name | Endpoint Definition | Analysis Method",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null",
      "protocol_text": "exact quote, or null if not consulted",
      "protocol_consulted": "yes | no | n/a",
      "matches_original_sap": "yes | no",
      "detail_level": "match | less_detailed | contradiction",
      "omitted_content": "list specific omissions or 'none'",
      "omission_impact": "none | low | potential",
      "result": "correct | acceptable | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "short description",
      "original_sap_text": "exact quote",
      "protocol_text": "exact quote if found, null if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "FULL VERBATIM QUOTE - NO truncation",
      "generated_sap_text": "FULL VERBATIM QUOTE - NO truncation",
      "protocol_text": "exact quote if relevant",
      "why_they_conflict": "explanation of why both cannot be true",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

**counts_match MUST be true for valid output.**

Before finalizing your output, verify:
- `elements_extracted` = `elements_in_evaluation_table` + `elements_in_missing_from_generated_sap`
- `elements_extracted` must equal 3
- If counts do not match, your output is INVALID

---

## CRITICAL REMINDERS

1. **First endpoint only**: Find the first efficacy endpoint in the Generated SAP. Evaluate only that one.
2. **Three components**: Endpoint Name, Endpoint Definition, Analysis Method. That is all.
3. **No assumptions**: Do not assume what the endpoint should be. Read it from the Generated SAP.
4. **EXISTENCE vs CONTENT**: Protocol is ONLY for checking if missing elements are required, NOT for evaluating content differences.
5. **Compare to Original SAP first**: For content, always compare Generated SAP to Original SAP.
6. **Contradiction is a problem**: Generated SAP saying something incompatible with Original SAP is a problem.
7. **Extra info is neutral**: Flag but do not penalize extra information unless it contradicts.
8. **Full quotes required**: NEVER use "..." to truncate quotes - always include complete text.
