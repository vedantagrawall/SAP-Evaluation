# General Methodology Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate ONLY the General Methods section of the Generated SAP.

**Start from the Generated SAP.** Find its General Methods section. Then find the corresponding content in the Original SAP for comparison.

For each item, ask: "Does this apply universally across all analyses, or does it belong to its own dedicated section?" If it belongs to its own section, skip it. If the General Methods section contains subsections with their own headings, only evaluate the content that appears before the first subsection heading. Each subsection is a separate topic and will be evaluated by its own prompt.

---

## EVALUATION HIERARCHY

Follow this order strictly:

1. **Compare Generated SAP to Original SAP first**
2. **If they match** → CORRECT, no further investigation needed
3. **If they differ** → Go to Protocol as tiebreaker
4. **If Generated SAP matches Protocol** → CORRECT (do not penalize, even if Original SAP differs)
5. **If Generated SAP matches neither Original SAP nor Protocol** → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: EXTRACTION

1. Find the General Methods section in the Generated SAP
2. List every distinct convention, rule, or definition stated in that section
3. For each item, find the corresponding content in the Original SAP (it may be in a different location)
4. Extract the EXACT TEXT from the Original SAP as the reference

**EXTRACTION RULES:**
- Each sentence is a separate entry
- If a sentence contains "X and Y" joining two distinct rules, split into separate entries
- Extract EXACT TEXT (word-for-word quotes)
- Do not paraphrase or summarize
- Only extract items that appear in the Generated SAP's General Methods section

### PHASE 2: COMPARISON AND CLASSIFICATION

For each extracted element:

**Step A**: Record the exact text from the Generated SAP's General Methods section

**Step B**: Find the corresponding content in the Original SAP and record it as original_sap_text. If the Original SAP has no corresponding content, record null.

**Step C**: Compare statements directly
- Ask: "Can both statements be true at the same time?"
- If YES → matches_original_sap: "yes"
- If NO → matches_original_sap: "no" (contradiction)
- Less detail is NOT a conflict
- Silence is NOT a conflict

**Step D**: Apply evaluation logic

| Scenario | Result | JSON Location |
|----------|--------|---------------|
| Both statements can be true | CORRECT | evaluation_table (result: correct) |
| Generated SAP is less detailed | CORRECT | evaluation_table (result: correct) |
| Statements conflict — cannot both be true | PROBLEM | evaluation_table (result: problem) |
| Element in Generated SAP but NOT in Original SAP | Flag as extra | extra_information_flagged |

### PHASE 3: INTERNAL CONSISTENCY CHECK

Scan the Generated SAP's General Methods section for internal contradictions only:
- Does one statement conflict with another statement within the same section?

---

## RATING CRITERIA

Rating is based ONLY on contradictions. Missing information does not affect the rating.

### GREAT
- No contradictions between Generated SAP and Original SAP
- No contradictions with Protocol
- No internal contradictions

### DECENT
- Minor contradictions that do not affect trial integrity
- Small inconsistencies easily correctable
- No Protocol contradictions

### POOR
- Critical contradictions with Protocol
- Generated SAP states something fundamentally incompatible with Original SAP
- Multiple contradictions
- Internal contradictions

---

## JSON OUTPUT

```json
{
  "section": "general_methodology",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "extraction_validation": {
    "sections_read": ["list every section number read"],
    "elements_per_section": {"section_name": "count"},
    "paragraphs_processed": 0,
    "elements_extracted": 0,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "short description",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null",
      "matches_original_sap": "yes | no",
      "protocol_text": "exact quote, or null if not consulted",
      "protocol_consulted": "yes | no | n/a",
      "result": "correct | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol | internal_contradiction",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "missing_from_generated_sap": [],

  "internal_contradictions": [
    {
      "component": "short description",
      "section_a": "section number",
      "section_a_text": "short quote",
      "section_b": "section number",
      "section_b_text": "short quote",
      "description": "how they conflict",
      "severity": "minor | critical"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol | internal_contradiction",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote",
      "protocol_text": "exact quote if relevant",
      "why_they_conflict": "explanation of why both cannot be true",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

counts_match MUST be true for valid output.
If evaluation_table.length + missing_from_generated_sap.length ≠ elements_extracted, your output is INVALID.

---

## CRITICAL REMINDERS

1. **Start from the Generated SAP**: Only evaluate content in the Generated SAP's General Methods section. Do not go looking for additional content in other sections.
2. **Stay in one section**: If content has its own dedicated section in either document, it does not belong here.
3. **No duplication**: Each piece of content should only be evaluated once across all prompts.
4. **Compare to Original SAP first**: Always compare Generated SAP to Original SAP before consulting Protocol.
5. **Protocol is tiebreaker**: Consult Protocol when Generated SAP content differs from Original SAP.
6. **Do not penalize Protocol compliance**: If Generated SAP matches Protocol but not Original SAP, that is CORRECT.
7. **Rating based on contradictions only**: Missing information does NOT affect rating.
8. **Blocking validation**: Ensure counts match before outputting.
