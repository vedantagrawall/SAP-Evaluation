# General Methodology Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate the General Methodology content in the Generated SAP by comparing it to the Original SAP.

**IMPORTANT**: Do not assume which rules, definitions, conventions, or procedures exist. Discover all general methodology content present in both documents by searching each document thoroughly.

**CRITICAL**: You MUST create separate entries for each individual rule, definition, convention, or procedure. Never bundle multiple distinct requirements into one entry. Each distinct requirement gets its own evaluation row.

---

## EVALUATION HIERARCHY

Follow this order strictly:

1. **Compare Generated SAP to Original SAP first**
2. **If they match** → CORRECT, no further investigation needed
3. **If they differ** → Go to Protocol as tiebreaker
4. **If Generated SAP matches Protocol** → CORRECT (do not penalize, even if Original SAP differs)
5. **If Generated SAP matches neither Original SAP nor Protocol** → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: EXHAUSTIVE EXTRACTION

Extract EVERY element from Original SAP. Do not skip anything. Do not make judgments about importance.
Read each paragraph individually. If a paragraph contains multiple requirements, extract each as a separate element.

**CONJUNCTION RULE (CRITICAL):**
When a sentence contains "X and Y" or "X, Y, and Z", each item is a SEPARATE element.
Split conjunctions BEFORE extraction:
- "EOT and unscheduled visits will not be summarized" = TWO elements
- "Mean and median will use one more decimal" = TWO elements
- "Sorted by treatment group and patient number" = TWO elements

**MANDATORY EXTRACTION CHECKLIST:**
You MUST extract elements for each category below. If Original SAP has content for a category, extract it. Mark categories as "not_found" only if truly absent.

Categories:
- software_version
- sample_size_calculation
- randomization_method
- stratification_factors
- blinding_procedure
- baseline_definition
- post_baseline_definition
- decimal_precision_mean
- decimal_precision_median
- decimal_precision_sd
- decimal_precision_minmax
- decimal_precision_geometric_mean
- decimal_precision_cv
- percentage_precision
- percentage_zero_handling
- percentage_denominator
- not_done_row_handling
- visit_handling_scheduled
- visit_handling_unscheduled
- visit_handling_eot
- listing_sort_order
- listing_inequality_signs
- quantification_limit_summary
- quantification_limit_listing
- outlier_handling
- missing_value_handling
- data_discrepancy_handling
- protocol_deviation_definition
- sensitivity_analyses

### PHASE 2: COMPARISON AND CLASSIFICATION

For EACH element extracted from Original SAP:

**Step A**: Search Generated SAP thoroughly
- Search the ENTIRE Generated SAP document
- Look in ALL sections, not just corresponding section names
- Document what you find (exact text or null if nothing found)

**Step B**: If content found, extract core meaning (CRITICAL)
- Reduce Original SAP statement to core meaning (e.g., INCLUDE vs EXCLUDE, REQUIRED vs OPTIONAL)
- Reduce Generated SAP statement to core meaning
- Compare the core meanings
- You MUST record both `original_core_meaning` and `generated_core_meaning` in the evaluation_table
- Example: Original says "will not be summarized" → core meaning = "EXCLUDE"
- Example: Generated says "will be mapped to windows" → core meaning = "INCLUDE"
- If core meanings are opposites (INCLUDE vs EXCLUDE), this is a CONTRADICTION

**Step C**: Classify based on comparison
- If Generated SAP has NO content on topic (null) → missing_from_generated_sap (ALWAYS)
- If Generated SAP has content that MATCHES → evaluation_table (correct)
- If Generated SAP has content that CONFLICTS → evaluation_table (problem/contradiction)

**Step D**: For missing items, check Protocol
- Search Protocol for the same element
- Record in_protocol: "yes" or "no"
- This determines classification but does NOT affect rating

**CRITICAL CLASSIFICATION RULE:**
Silence is NEVER a contradiction. If generated_sap_text is null or empty, it MUST go to missing_from_generated_sap.
A contradiction REQUIRES Generated SAP to ACTIVELY STATE something conflicting.

### PHASE 3: INTERNAL CONSISTENCY CHECK

Scan the Generated SAP for internal contradictions:
- Does Section A say something that conflicts with Section B?
- Are definitions consistent across all sections?
- Are statistical methods described consistently?

---

## CONTRADICTION DETECTION LOGIC

A contradiction is when two statements CONFLICT (cannot both be true).
Missing detail is NOT a contradiction.
Silence is NOT a contradiction.

**Semantic Conflict Detection:**
Before classifying, reduce both statements to their core instruction:
- INCLUDE vs EXCLUDE
- REQUIRED vs OPTIONAL
- VALUE X vs VALUE Y
- METHOD A vs METHOD B

If the core instructions conflict, it IS a contradiction regardless of different wording.

**Type 1: Contradiction with Original SAP**
- Generated ACTIVELY STATES X
- Original ACTIVELY STATES NOT X
- EXCEPTION: If Generated matches Protocol → Generated is CORRECT

**Type 2: Contradiction with Protocol (Critical)**
- Generated ACTIVELY STATES X
- Protocol ACTIVELY STATES NOT X
- Flag as CRITICAL severity

**Type 3: Internal Contradiction**
- Generated SAP Section A says X
- Generated SAP Section B says NOT X
- Flag as inconsistency

---

## RATING CRITERIA

Rating is based ONLY on contradictions. Missing information does not affect the rating.

### GREAT
- No contradictions between Generated SAP and Original SAP
- No contradictions with Protocol
- No internal contradictions in Generated SAP

### DECENT
- Minor contradictions that do not affect trial integrity
- Small inconsistencies easily correctable
- No Protocol contradictions

### POOR
- Critical contradictions with Protocol
- Generated SAP states something fundamentally incompatible with Original SAP
- Multiple contradictions across different topics
- Internal contradictions in Generated SAP

---

## OUTPUT FORMAT

Provide BOTH markdown (for human review) AND JSON (for programmatic use).

---

## MARKDOWN OUTPUT

```markdown
## General Methodology Evaluation

**Section:** general_methodology
**Rating:** [GREAT | DECENT | POOR]
**Status:** [pass | pass_with_notes | fail]

---

### Evaluation Summary Table

| Component | Category | Matches Original SAP | Protocol Consulted | Result | Issue Type | Severity |
|-----------|----------|---------------------|-------------------|--------|------------|----------|
| [description] | [category] | yes/no | yes/no/n/a | correct/problem | none/contradiction | none/minor/critical |

---

### Issues Found

| Issue Type | Severity | Component | Original Core Meaning | Generated Core Meaning | Description |
|------------|----------|-----------|----------------------|------------------------|-------------|
| [contradiction_original/contradiction_protocol/internal] | [minor/critical] | [name] | [INCLUDE/EXCLUDE/etc.] | [INCLUDE/EXCLUDE/etc.] | [explanation] |

(If no issues: "*No issues found.*")

---

### Extra Information Flagged

| Content | Contradicts | Detail |
|---------|-------------|--------|
| [description] | yes/no | [explanation] |

(If none: "*No extra information flagged.*")

---

### ❌ Missing Required Content (X items)

Content in both Original SAP AND Protocol - should be in Generated SAP.

| Component | Category | Original SAP Text | Protocol Text |
|-----------|----------|-------------------|---------------|
| [name] | [category] | "[quote]" | "[quote]" |

(If none: "*None - all required content is present.*")

---

### ⚠️ Protocol Content Not In Generated SAP (X items)

Content in Protocol but not in Generated SAP.

| Component | Category | Protocol Text | Description |
|-----------|----------|---------------|-------------|
| [name] | [category] | "[quote]" | [explanation] |

(If none: "*No protocol content missing.*")

---

### Internal Contradictions

| Component | Section A | Section A Text | Section B | Section B Text | Description |
|-----------|-----------|----------------|-----------|----------------|-------------|
| [name] | [section] | "[quote]" | [section] | "[quote]" | [how they conflict] |

(If none: "*No internal contradictions found.*")

---

### Reasoning

[Step-by-step chain-of-thought reasoning trace]

---

### Summary

[2-3 sentence overall assessment]
```

---

## JSON OUTPUT

```json
{
  "section": "general_methodology",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "extraction_validation": {
    "sections_read": ["list every section number read"],
    "elements_per_section": {"section_name": "count"},
    "categories_found": {
      "visit_handling_unscheduled": true,
      "visit_handling_eot": true
    },
    "paragraphs_processed": 0,
    "elements_extracted": 0,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "short description",
      "category": "category from checklist",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "original_core_meaning": "INCLUDE | EXCLUDE | REQUIRED | OPTIONAL | VALUE",
      "generated_sap_text": "exact quote (MUST NOT BE NULL)",
      "generated_core_meaning": "INCLUDE | EXCLUDE | REQUIRED | OPTIONAL | VALUE",
      "protocol_text": "exact quote, or null if not consulted",
      "matches_original_sap": "yes | no",
      "protocol_consulted": "yes | no | n/a",
      "result": "correct | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol | internal_contradiction",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "short description",
      "category": "category from checklist",
      "content_type": "descriptive label",
      "original_sap_text": "exact quote",
      "protocol_text": "exact quote if found, null if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing"
    }
  ],

  "protocol_content_not_in_generated_sap": [
    {
      "component": "short description",
      "category": "category from checklist",
      "content_type": "descriptive label",
      "protocol_text": "exact quote from Protocol",
      "description": "explanation of what is missing"
    }
  ],

  "internal_contradictions": [
    {
      "component": "short description",
      "section_a": "section number",
      "section_a_text": "short quote",
      "section_b": "section number",
      "section_b_text": "short quote",
      "description": "how they conflict",
      "severity": "minor | critical"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol | internal_contradiction",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "exact quote",
      "original_core_meaning": "the core instruction (INCLUDE/EXCLUDE/etc.)",
      "generated_sap_text": "exact quote",
      "generated_core_meaning": "the core instruction (INCLUDE/EXCLUDE/etc.)",
      "protocol_text": "exact quote if relevant",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

counts_match MUST be true for valid output.
If evaluation_table.length + missing_from_generated_sap.length ≠ elements_extracted, your output is INVALID.

---

## CRITICAL REMINDERS

1. **Conjunction splitting**: "X and Y" = TWO separate elements. Split BEFORE extraction.
2. **Silence = Missing**: If generated_sap_text would be null → goes to missing_from_generated_sap, NOT a contradiction.
3. **Compare to Original SAP first**: Always compare Generated SAP to Original SAP before consulting Protocol.
4. **Protocol is tiebreaker**: Only consult Protocol when Generated SAP differs from Original SAP.
5. **Do not penalize Protocol compliance**: If Generated SAP matches Protocol but not Original SAP, that is CORRECT.
6. **Rating based on contradictions only**: Missing information does NOT affect rating.
7. **Internal consistency**: Check for contradictions within the Generated SAP itself.
8. **Use categories**: Each element must have a category from the mandatory checklist.
9. **Blocking validation**: Ensure counts match before outputting.
