# General Methodology Evaluation Prompt

You are evaluating a Generated SAP against an Original SAP for a clinical trial.

---

## DOCUMENTS PROVIDED

- **ORIGINAL SAP**: Human-written reference SAP
- **GENERATED SAP**: Auto-generated SAP being evaluated
- **PROTOCOL**: Source of truth when discrepancies arise

---

## YOUR TASK

Evaluate the General Methodology content in the Generated SAP by comparing it to the Original SAP.

**IMPORTANT**: Do not assume which rules, definitions, conventions, or procedures exist. Discover all general methodology content present in both documents by searching each document thoroughly.

**CRITICAL**: You MUST create separate entries for each individual rule, definition, convention, or procedure. Never bundle multiple distinct requirements into one entry. Each distinct requirement gets its own evaluation row.

---

## EVALUATION HIERARCHY

Follow this order strictly:

1. **Compare Generated SAP to Original SAP first**
2. **If they match** → CORRECT, no further investigation needed
3. **If they differ** → Go to Protocol as tiebreaker
4. **If Generated SAP matches Protocol** → CORRECT (do not penalize, even if Original SAP differs)
5. **If Generated SAP matches neither Original SAP nor Protocol** → PROBLEM

---

## EVALUATION APPROACH

This evaluation has three phases. Complete each phase fully before the next.

### PHASE 1: EXHAUSTIVE EXTRACTION

Read the Original SAP document line by line. For each statement, rule, or definition:
1. Extract the EXACT TEXT (word-for-word quote)
2. Do not paraphrase or summarize
3. Do not fit into predefined categories
4. Create one entry per statement

**CONJUNCTION RULE (CRITICAL):**
When a sentence contains "X and Y" or "X, Y, and Z", split into SEPARATE elements.

**CONJUNCTION VERIFICATION:**
Before moving to Phase 2, review every extracted element. If any element contains "and" or "or" joining two different items, STOP and split it into separate entries.

### PHASE 2: COMPARISON AND CLASSIFICATION

**TRACKING RULE:**
Every element extracted in Phase 1 MUST appear in either evaluation_table OR missing_from_generated_sap. No element can be skipped or lost.

**Step A**: For each extracted element, search Generated SAP
- Identify the key terms from the Original SAP element
- Search the ENTIRE Generated SAP for those key terms
- When found, copy the EXACT sentence word-for-word as generated_sap_text
- Do NOT paraphrase, summarize, or reword what you find
- Only record null if no content with those key terms exists in the entire document

**Step B**: Compare statements directly
- Ask: "Can both statements be true at the same time?"
- If YES → no conflict (statements are compatible)
- If NO → contradiction (statements conflict)
- Less detail is NOT a conflict
- Silence is NOT a conflict

**Step C**: Apply Evaluation Logic

| Scenario | Result | JSON Location |
|----------|--------|---------------|
| Both statements can be true at the same time | ✅ CORRECT | evaluation_table (result: correct) |
| Generated SAP is less detailed than Original SAP | ✅ ACCEPTABLE | evaluation_table (result: correct) |
| Statements conflict, but Generated MATCHES Protocol | ✅ CORRECT | evaluation_table (result: correct, protocol_consulted: yes) |
| Statements conflict, Protocol is SILENT | ❌ PROBLEM | evaluation_table (result: problem, issue_type: contradiction_original) |
| Statements conflict with Protocol | ❌ PROBLEM | evaluation_table (result: problem, issue_type: contradiction_protocol) |
| Element missing from Generated, EXISTS in Protocol | ❌ PROBLEM | missing_from_generated_sap (in_protocol: yes, classification: missing_required) |
| Element missing from Generated, NOT in Protocol | ✅ ACCEPTABLE | missing_from_generated_sap (in_protocol: no, classification: acceptable_difference) |

**CONTENT vs EXISTENCE Hierarchy:**

For CONTENT (what it says):
- Compare Generated SAP to Original SAP
- Match or less detail = CORRECT
- DIFFERENT content = PROBLEM/CONTRADICTION

For EXISTENCE (whether it's there):
- Check Original SAP first
- If missing from Generated, check Protocol
- If Protocol has it → Generated MUST have it (missing_required)
- If only Original has it → acceptable to omit (acceptable_difference)

**Step D**: For missing items, check Protocol
- Search the ENTIRE Protocol document for the same element
- Content may be worded differently - look for semantic match
- Look in ALL sections, not just sections with similar names
- Record in_protocol: "yes" if concept exists (even if worded differently)
- Record in_protocol: "no" ONLY if concept is truly absent after thorough search

**CRITICAL RULES:**
1. Each statement = separate entry (NEVER combine)
2. "Less detail" ≠ "Different content" - abbreviation is OK, contradiction is not
3. If both statements cannot be true at the same time → CONTRADICTION (flag it)

### PHASE 3: INTERNAL CONSISTENCY CHECK

Scan the Generated SAP for internal contradictions:
- Does Section A say something that conflicts with Section B?
- Are definitions consistent across all sections?
- Are statistical methods described consistently?

---

## CONTRADICTION DETECTION LOGIC

A contradiction is when two statements CANNOT BOTH BE TRUE.
Missing detail is NOT a contradiction.
Silence is NOT a contradiction.

**How to detect conflicts:**
Ask: "Can both statements be true at the same time?"
- If NO → they conflict
- If YES → no conflict

**Type 1: Contradiction with Original SAP**
- Generated ACTIVELY STATES something
- Original ACTIVELY STATES something incompatible
- Both cannot be true at the same time
- EXCEPTION: If Generated matches Protocol → Generated is CORRECT

**Type 2: Contradiction with Protocol (Critical)**
- Generated ACTIVELY STATES X
- Protocol ACTIVELY STATES NOT X
- Flag as CRITICAL severity

**Type 3: Internal Contradiction**
- Generated SAP Section A says X
- Generated SAP Section B says NOT X
- Flag as inconsistency

---

## RATING CRITERIA

Rating is based ONLY on contradictions. Missing information does not affect the rating.

### GREAT
- No contradictions between Generated SAP and Original SAP
- No contradictions with Protocol
- No internal contradictions in Generated SAP

### DECENT
- Minor contradictions that do not affect trial integrity
- Small inconsistencies easily correctable
- No Protocol contradictions

### POOR
- Critical contradictions with Protocol
- Generated SAP states something fundamentally incompatible with Original SAP
- Multiple contradictions across different topics
- Internal contradictions in Generated SAP

---

## OUTPUT FORMAT

Provide BOTH markdown (for human review) AND JSON (for programmatic use).

---

## MARKDOWN OUTPUT

```markdown
## General Methodology Evaluation

**Section:** general_methodology
**Rating:** [GREAT | DECENT | POOR]
**Status:** [pass | pass_with_notes | fail]

---

### Evaluation Summary Table

| Component | Matches Original SAP | Protocol Consulted | Result | Issue Type | Severity |
|-----------|---------------------|-------------------|--------|------------|----------|
| [description] | yes/no | yes/no/n/a | correct/problem | none/contradiction | none/minor/critical |

---

### Issues Found

| Issue Type | Severity | Component | Why They Conflict | Description |
|------------|----------|-----------|-------------------|-------------|
| [type] | [severity] | [name] | [why both cannot be true] | [explanation] |

(If no issues: "*No issues found.*")

---

### Extra Information Flagged

| Content | Contradicts | Detail |
|---------|-------------|--------|
| [description] | yes/no | [explanation] |

(If none: "*No extra information flagged.*")

---

### ❌ Missing Required Content (X items)

Content in both Original SAP AND Protocol - should be in Generated SAP.

| Component | Original SAP Text | Protocol Text |
|-----------|-------------------|---------------|
| [name] | "[quote]" | "[quote]" |

(If none: "*None - all required content is present.*")

---

### Internal Contradictions

| Component | Section A | Section A Text | Section B | Section B Text | Description |
|-----------|-----------|----------------|-----------|----------------|-------------|
| [name] | [section] | "[quote]" | [section] | "[quote]" | [how they conflict] |

(If none: "*No internal contradictions found.*")

---

### Reasoning

[Step-by-step chain-of-thought reasoning trace]

---

### Summary

[2-3 sentence overall assessment]
```

---

## JSON OUTPUT

```json
{
  "section": "general_methodology",
  "rating": "GREAT | DECENT | POOR",
  "status": "pass | pass_with_notes | fail",

  "extraction_validation": {
    "sections_read": ["list every section number read"],
    "elements_per_section": {"section_name": "count"},
    "paragraphs_processed": 0,
    "elements_extracted": 0,
    "elements_in_evaluation_table": 0,
    "elements_in_missing_from_generated_sap": 0,
    "counts_match": true
  },

  "evaluation_table": [
    {
      "component": "short description",
      "evaluation_type": "exact_match | semantic",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote or null",
      "can_both_be_true": "yes | no",
      "protocol_text": "exact quote, or null if not consulted",
      "protocol_consulted": "yes | no | n/a",
      "result": "correct | problem",
      "issue_type": "none | contradiction_original | contradiction_protocol | internal_contradiction",
      "severity": "none | minor | critical",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "missing_from_generated_sap": [
    {
      "component": "short description",
      "original_sap_text": "exact quote",
      "protocol_text": "exact quote if found, null if not",
      "in_protocol": "yes | no",
      "classification": "missing_required | acceptable_difference",
      "description": "explanation of what is missing"
    }
  ],

  "internal_contradictions": [
    {
      "component": "short description",
      "section_a": "section number",
      "section_a_text": "short quote",
      "section_b": "section number",
      "section_b_text": "short quote",
      "description": "how they conflict",
      "severity": "minor | critical"
    }
  ],

  "issues": [
    {
      "issue_type": "contradiction_original | contradiction_protocol | internal_contradiction",
      "severity": "minor | critical",
      "component": "short description",
      "original_sap_text": "exact quote",
      "generated_sap_text": "exact quote",
      "protocol_text": "exact quote if relevant",
      "why_they_conflict": "explanation of why both cannot be true",
      "description": "explanation of the issue",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "extra_information_flagged": [
    {
      "content": "description of extra content",
      "generated_sap_text": "exact quote from Generated SAP",
      "contradicts": "yes | no",
      "detail": "explanation if contradicts",
      "reasoning": "Chain-of-thought explanation"
    }
  ],

  "reasoning": "Step-by-step chain-of-thought reasoning trace",

  "summary": "2-3 sentence overall assessment"
}
```

---

## BLOCKING VALIDATION

counts_match MUST be true for valid output.
If evaluation_table.length + missing_from_generated_sap.length ≠ elements_extracted, your output is INVALID.

---

## CRITICAL REMINDERS

1. **Conjunction splitting**: Split "X and Y" into TWO separate elements.
2. **Silence = Missing**: If generated_sap_text would be null → goes to missing_from_generated_sap, NOT a contradiction.
3. **Compare to Original SAP first**: Always compare Generated SAP to Original SAP before consulting Protocol.
4. **Protocol is tiebreaker**: Consult Protocol when (1) Generated SAP content differs from Original SAP, OR (2) content is missing from Generated SAP.
5. **Do not penalize Protocol compliance**: If Generated SAP matches Protocol but not Original SAP, that is CORRECT.
6. **Rating based on contradictions only**: Missing information does NOT affect rating.
7. **Internal consistency**: Check for contradictions within the Generated SAP itself.
8. **Blocking validation**: Ensure counts match before outputting.
